<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>일광중학교 결시자 인정점 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Noto Sans KR', sans-serif; }
    .selected { 
      @apply ring-4 ring-blue-300 ring-opacity-50 transform scale-105; 
    }
    .btn-hover:hover { 
      @apply transform scale-105 transition-all duration-200; 
    }
  </style>
  <!-- ✅ Excel 저장 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
      <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">🏫 일광중학교 결시자 인정점 계산기</h1>
      <p class="text-gray-600 text-center mb-8">인정점 계산을 보다 편리하게😊</p>

            
            <!-- 학년/과목 선택 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">👤 학년/과목 선택</h2>
                <div class="bg-gray-50 rounded-xl p-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">학년</label>
                            <select id="student-grade" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">선택</option>
                                <option value="1">1학년</option>
                                <option value="2">2학년</option>
                                <option value="3">3학년</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">과목</label>
                            <select id="student-subject" onchange="handleSubjectChange()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">선택</option>
                                <option value="국어">국어</option>
                                <option value="영어">영어</option>
                                <option value="수학">수학</option>
                                <option value="사회">사회</option>
                                <option value="과학">과학</option>
                                <option value="도덕">도덕</option>
                                <option value="한문">한문</option>
                                <option value="역사">역사</option>
                                <option value="기술가정">기술가정</option>
                                <option value="정보">정보</option>
                                <option value="음악">음악</option>
                                <option value="미술">미술</option>
                                <option value="체육">체육</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 평균 점수 관리 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">📊 평균 점수 관리</h2>
                <div class="bg-blue-50 rounded-xl p-6 mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-blue-800 text-sm">
                            <strong>💡 안내:</strong> 한 번 입력한 평균 점수는 자동으로 저장되어 다음 계산에서 재사용됩니다.
                        </p>
                        <button type="button" onclick="clearAllAverages()" 
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            전체 초기화
                        </button>
                    </div>
                    
                    <!-- 지필고사 평균 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="written-exam-averages">
                        <div class="bg-white rounded-lg p-4 border border-blue-200">
                            <h3 class="font-semibold text-blue-800 mb-2">중간고사 평균</h3>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="number" step="0.1" id="saved-midterm-avg" placeholder="예: 75.5" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       onchange="saveAverage('midterm', this.value)">
                                <button type="button" onclick="clearAverage('midterm')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" step="0.1" id="saved-midterm-min" placeholder="최하점 (예: 40)" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       onchange="saveMinScore('midterm', this.value)">
                                <button type="button" onclick="clearMinScore('midterm')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 border border-blue-200">
                            <h3 class="font-semibold text-blue-800 mb-2">기말고사 평균</h3>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="number" step="0.1" id="saved-final-avg" placeholder="예: 78.2" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       onchange="saveAverage('final', this.value)">
                                <button type="button" onclick="clearAverage('final')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" step="0.1" id="saved-final-min" placeholder="최하점 (예: 40)" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       onchange="saveMinScore('final', this.value)">
                                <button type="button" onclick="clearMinScore('final')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 영어듣기 평균 (영어 과목 선택 시에만 표시) -->
                    <div class="grid grid-cols-1 gap-4 mb-6 hidden" id="english-listening-average">
                        <div class="bg-white rounded-lg p-4 border border-orange-200">
                            <h3 class="font-semibold text-orange-800 mb-2">🎧 영어듣기 평균</h3>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="number" step="0.1" id="saved-listening-avg" placeholder="예: 82.5" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                       onchange="saveAverage('englishListening', this.value)">
                                <button type="button" onclick="clearAverage('englishListening')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" step="0.1" id="saved-listening-min" placeholder="최하점 (예: 40)" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                       onchange="saveMinScore('englishListening', this.value)">
                                <button type="button" onclick="clearMinScore('englishListening')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 수행평가 평균 (모든 과목에서 표시) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="performance-averages">
                        <div class="bg-white rounded-lg p-4 border border-purple-200">
                            <h3 class="font-semibold text-purple-800 mb-2">🎨 <span id="performance1-title">수행평가 1</span></h3>
                            <div class="mb-2">
                                <input type="text" id="saved-performance1-name" placeholder="영역명 (예: 실기)" 
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="savePerformanceAreaName('performance1', this.value)">
                            </div>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="number" step="0.1" id="saved-performance1-avg" placeholder="예: 85.0" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="saveAverage('performance1', this.value)">
                                <button type="button" onclick="clearPerformanceArea('performance1')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" step="0.1" id="saved-performance1-min" placeholder="최하점 (예: 40)" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="saveMinScore('performance1', this.value)">
                                <button type="button" onclick="clearMinScore('performance1')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 border border-purple-200">
                            <h3 class="font-semibold text-purple-800 mb-2">🎨 <span id="performance2-title">수행평가 2</span></h3>
                            <div class="mb-2">
                                <input type="text" id="saved-performance2-name" placeholder="영역명 (예: 이론)" 
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="savePerformanceAreaName('performance2', this.value)">
                            </div>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="number" step="0.1" id="saved-performance2-avg" placeholder="예: 87.5" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="saveAverage('performance2', this.value)">
                                <button type="button" onclick="clearPerformanceArea('performance2')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" step="0.1" id="saved-performance2-min" placeholder="최하점 (예: 40)" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="saveMinScore('performance2', this.value)">
                                <button type="button" onclick="clearMinScore('performance2')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 border border-purple-200">
                            <h3 class="font-semibold text-purple-800 mb-2">🎨 <span id="performance3-title">수행평가 3</span></h3>
                            <div class="mb-2">
                                <input type="text" id="saved-performance3-name" placeholder="영역명 (예: 태도)" 
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="savePerformanceAreaName('performance3', this.value)">
                            </div>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="number" step="0.1" id="saved-performance3-avg" placeholder="예: 83.2" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="saveAverage('performance3', this.value)">
                                <button type="button" onclick="clearPerformanceArea('performance3')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" step="0.1" id="saved-performance3-min" placeholder="최하점 (예: 40)" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="saveMinScore('performance3', this.value)">
                                <button type="button" onclick="clearMinScore('performance3')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 border border-purple-200">
                            <h3 class="font-semibold text-purple-800 mb-2">🎨 <span id="performance4-title">수행평가 4</span></h3>
                            <div class="mb-2">
                                <input type="text" id="saved-performance4-name" placeholder="영역명 (예: 포트폴리오)" 
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="savePerformanceAreaName('performance4', this.value)">
                            </div>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="number" step="0.1" id="saved-performance4-avg" placeholder="예: 88.3" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="saveAverage('performance4', this.value)">
                                <button type="button" onclick="clearPerformanceArea('performance4')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" step="0.1" id="saved-performance4-min" placeholder="최하점 (예: 40)" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       onchange="saveMinScore('performance4', this.value)">
                                <button type="button" onclick="clearMinScore('performance4')" 
                                        class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <!-- 학생 정보 입력 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">👤 학생 정보</h2>
                <div class="bg-gray-50 rounded-xl p-6">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">반</label>
                            <input type="number" id="student-class" placeholder="예: 3" min="1" max="20"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">번호</label>
                            <input type="number" id="student-number" placeholder="예: 15" min="1" max="50"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">이름</label>
                            <input type="text" id="student-name" placeholder="예: 홍길동"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 시험 유형 선택 -->
            <div id="exam-type-section" class="mb-8">
                <label class="block text-lg font-semibold text-gray-700 mb-4">결시한 시험 유형</label>
                <div id="exam-type-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button type="button" onclick="selectExamType('midterm')" id="midterm-btn" 
                            class="btn-hover bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium py-4 px-6 rounded-xl border-2 border-blue-200 transition-all duration-200">
                        중간고사
                    </button>
                    <button type="button" onclick="selectExamType('final')" id="final-btn" 
                            class="btn-hover bg-green-100 hover:bg-green-200 text-green-800 font-medium py-4 px-6 rounded-xl border-2 border-green-200 transition-all duration-200">
                        기말고사
                    </button>
                    <button type="button" onclick="selectExamType('performance')" id="performance-btn" 
                            class="btn-hover bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-4 px-6 rounded-xl border-2 border-purple-200 transition-all duration-200">
                        수행평가
                    </button>
                    <button type="button" onclick="selectExamType('english-listening')" id="english-listening-btn" 
                            class="btn-hover bg-orange-100 hover:bg-orange-200 text-orange-800 font-medium py-4 px-6 rounded-xl border-2 border-orange-200 transition-all duration-200 hidden">
                        🎧 영어듣기
                    </button>
                </div>
                <div id="performance-only-notice" class="hidden mt-4 bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <p class="text-purple-800 text-sm">
                        <strong>💡 안내:</strong> 선택하신 과목은 수행평가만 실시되는 과목입니다.
                    </p>
                </div>
                <div id="english-listening-notice" class="hidden mt-4 bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <p class="text-orange-800 text-sm">
                        <strong>🎧 안내:</strong> 영어 과목에서는 영어듣기 평가 인정점도 계산할 수 있습니다.
                    </p>
                </div>
            </div>

            <!-- 결시 사유 선택 -->
            <div id="absence-reason" class="mb-8 hidden">
                <label class="block text-lg font-semibold text-gray-700 mb-4">결시 사유</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button type="button" onclick="selectAbsenceReason('sick')" id="sick-btn" 
                            class="btn-hover bg-red-100 hover:bg-red-200 text-red-800 font-medium py-4 px-6 rounded-xl border-2 border-red-200 transition-all duration-200">
                        <div class="text-center">
                            <div class="font-semibold">병결</div>
                            <div class="text-sm">80% 인정</div>
                        </div>
                    </button>
                    <button type="button" onclick="selectAbsenceReason('approved')" id="approved-btn" 
                            class="btn-hover bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium py-4 px-6 rounded-xl border-2 border-blue-200 transition-all duration-200">
                        <div class="text-center">
                            <div class="font-semibold">인정결</div>
                            <div class="text-sm">100% 인정</div>
                        </div>
                    </button>
                    <button type="button" onclick="selectAbsenceReason('unapproved')" id="unapproved-btn" 
                            class="btn-hover bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-4 px-6 rounded-xl border-2 border-gray-200 transition-all duration-200">
                        <div class="text-center">
                            <div class="font-semibold">미인정결</div>
                            <div class="text-sm">최하점-1점</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- 계산 방식 선택 -->
            <div id="calculation-method" class="mb-8 hidden">
                <label class="block text-lg font-semibold text-gray-700 mb-4">계산 방식 선택</label>
                <div id="method-options" class="space-y-3">
                    <!-- 동적으로 생성됩니다 -->
                </div>
            </div>

            <!-- 입력 폼 -->
            <div id="input-form" class="mb-8 hidden">
                <div class="bg-gray-50 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">필요한 정보를 입력하세요</h3>
                    <div id="input-fields" class="space-y-4">
                        <!-- 동적으로 생성됩니다 -->
                    </div>
                    <button type="button" onclick="calculateScore()" 
                            class="w-full mt-6 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105">
                        인정점 계산하기
                    </button>
                </div>
            </div>

            <!-- 결과 표시 -->
            <div id="result" class="hidden">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-green-800">📊 계산 결과</h3>
                      <div class="space-x-2">
  <button type="button" onclick="copyResults()" class="bg-purple-500 ...">복사하기</button>
  <button type="button" onclick="downloadExcel()" class="bg-green-500 ...">Excel 저장</button>
  <button type="button" onclick="clearResults()" class="bg-red-500 ...">전체 삭제</button>
</div>

                    </div>
                    <div class="overflow-x-auto">
                        <table id="results-table" class="w-full border-collapse border border-gray-300 bg-white rounded-lg overflow-hidden shadow-sm">
                            <thead>
                                <tr class="bg-green-100">
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">번호</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">학년</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">반</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">번호</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">이름</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">과목</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">결시시험</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">세부명</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">결시사유</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">인정비율</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">산출기준</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">기준점</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">인정점</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">비고</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">삭제</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                                <!-- 결과가 여기에 누적됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 계산 공식 안내 버튼 -->
        <div class="text-center">
            <button type="button" onclick="openFormulaModal()" 
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-medium transition-all duration-200 border border-gray-300">
                📋 계산 공식 안내 보기
            </button>
        </div>
    </div>

    <!-- 계산기 모달 -->
    <div id="calculator-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="calculator-title" class="text-lg font-semibold text-gray-800">평균 계산기</h3>
                <button type="button" onclick="closeCalculator()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="calculator-content">
                <!-- 동적으로 생성됩니다 -->
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeCalculator()" 
                        class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                    취소
                </button>
                <button type="button" onclick="applyCalculation()" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-200">
                    적용
                </button>
            </div>
        </div>
    </div>

    <!-- 저장된 수행평가 선택 모달 -->
    <div id="performance-dropdown-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">저장된 수행평가 선택</h3>
                <button type="button" onclick="closePerformanceDropdown()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="performance-dropdown-content" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- 동적으로 생성됩니다 -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="closePerformanceDropdown()" 
                        class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                    취소
                </button>
            </div>
        </div>
    </div>

    <!-- 계산기 내 저장된 값 선택 모달 -->
    <div id="calculator-saved-values-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">저장된 수행평가 값 선택</h3>
                <button type="button" onclick="closeCalculatorSavedValues()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="calculator-saved-values-content" class="space-y-3">
                <!-- 동적으로 생성됩니다 -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="closeCalculatorSavedValues()" 
                        class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                    취소
                </button>
            </div>
        </div>
    </div>

    <!-- 계산 공식 안내 모달 -->
    <div id="formula-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">📋 계산 공식 안내</h3>
                <button type="button" onclick="closeFormulaModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-6">
                <h3 class="font-semibold text-yellow-800 mb-3">🎯 결시 사유별 인정 비율</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="text-center p-3 bg-red-100 rounded-lg">
                        <div class="font-semibold text-red-800">병결</div>
                        <div class="text-red-600">계산된 점수의 80%</div>
                    </div>
                    <div class="text-center p-3 bg-blue-100 rounded-lg">
                        <div class="font-semibold text-blue-800">인정결</div>
                        <div class="text-blue-600">계산된 점수의 100%</div>
                    </div>
                    <div class="text-center p-3 bg-gray-100 rounded-lg">
                        <div class="font-semibold text-gray-800">미인정결</div>
                        <div class="text-gray-600">최하점 - 1점</div>
                    </div>
                </div>
            </div>

            <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-6">
                <h3 class="font-semibold text-green-800 mb-3">📝 수행평가 인정점 계산 예시</h3>
                <div class="text-sm text-green-700 space-y-2">
                    <p><strong>상황:</strong> 국어 수행평가 A, B, C 영역 중 A영역을 결시한 경우</p>
                    <p><strong>해당 학생의 다른 수행평가 점수:</strong> B영역 85점, C영역 90점 → 평균 87.5점</p>
                    <p><strong>전체 학생의 다른 수행평가 평균:</strong> B영역 평균 80점, C영역 평균 82점 → 평균 81점</p>
                    <p><strong>전체 학생의 결시한 수행평가 평균:</strong> A영역 평균 78점</p>
                    <p><strong>계산:</strong> 87.5 × (78 ÷ 81) × 인정비율 = 84.26 × 인정비율</p>
                </div>
            </div>

            <div class="space-y-6">
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="font-semibold text-blue-800 mb-2">중간고사 인정점</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 기말고사 성적 있음: (기말점수 ÷ 기말평균) × 중간평균 × 인정비율</li>
                        <li>• 수행평가만 있음: (수행점수 ÷ 수행평균) × 중간평균 × 인정비율</li>
                        <li>• 성적 없음: 중간고사 최하점 - 1점</li>
                    </ul>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-semibold text-green-800 mb-2">기말고사 인정점</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 중간고사 성적 있음: (중간점수 ÷ 중간평균) × 기말평균 × 인정비율</li>
                        <li>• 수행평가만 있음: (수행점수 ÷ 수행평균) × 기말평균 × 인정비율</li>
                        <li>• 성적 없음: 기말고사 최하점 - 1점</li>
                    </ul>
                </div>
                <div class="border-l-4 border-purple-500 pl-4">
                    <h3 class="font-semibold text-purple-800 mb-2">수행평가 인정점</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 다른 수행평가 있음: 학생의 다른영역 평균점수 × (결시영역 전체평균 ÷ 다른영역 전체평균) × 인정비율</li>
                        <li>• 지필평가만 있음: 학생의 지필평가점수 × (수행평가 전체평균 ÷ 지필평가 전체평균) × 인정비율</li>
                        <li>• 성적 없음: 수행평가 최하점 - 1점</li>
                    </ul>
                </div>
                <div class="border-l-4 border-orange-500 pl-4">
                    <h3 class="font-semibold text-orange-800 mb-2">영어듣기 평가 인정점</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 지필고사 성적 있음: (학생 영어지필점수 ÷ 영어지필평균) × 영어듣기평균 × 인정비율</li>
                        <li>• 수행평가만 있음: 학생 수행평균점수 × (영어듣기평균 ÷ 영어듣기제외 수행평균) × 인정비율</li>
                        <li>• 성적 없음: 영어듣기 최하점 - 1점</li>
                    </ul>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button type="button" onclick="closeFormulaModal()" 
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-200">
                    확인
                </button>
            </div>
        </div>
    </div>

    <script>
  let currentExamType = '';
  let currentAbsenceReason = '';
  let isPerformanceOnlySubject = false;
  let resultsData = [];
  let savedAverages = { midterm:null, final:null, performance:{}, englishListening:null, performance1:null, performance2:null, performance3:null, performance4:null };
  let savedPerformanceAreaNames = { performance1:null, performance2:null, performance3:null, performance4:null };

  /* ✅ 과목 변경 시 초기화 */
  function handleSubjectChange() {
    const subject = document.getElementById('student-subject').value;
    const onlyPerf = ['음악','미술','체육'];
    isPerformanceOnlySubject = onlyPerf.includes(subject);
    resetExamTypeSelection();
  }

  function resetExamTypeSelection(){
    currentExamType = '';
    currentAbsenceReason = '';
    document.querySelectorAll('.btn-hover').forEach(btn=>btn.classList.remove('selected'));
    document.getElementById('absence-reason').classList.add('hidden');
    document.getElementById('calculation-method').classList.add('hidden');
    document.getElementById('input-form').classList.add('hidden');
  }

  /* ✅ 시험유형 클릭 시 결시사유 보이도록 수정 */
  function selectExamType(type){
    if(isPerformanceOnlySubject && (type==='midterm'||type==='final')) return;
    currentExamType = type;
    document.querySelectorAll('.btn-hover').forEach(btn=>btn.classList.remove('selected'));
    document.getElementById(type+'-btn').classList.add('selected');
    document.getElementById('absence-reason').classList.remove('hidden'); // 👈 여기에 추가!
    document.getElementById('calculation-method').classList.add('hidden');
    document.getElementById('input-form').classList.add('hidden');
  }

  /* ✅ showInputForm: 수행평가에서 name/avg 나란히 */
  function showInputForm(examType,method){
    const formDiv=document.getElementById('input-form');
    const fieldsDiv=document.getElementById('input-fields');
    formDiv.classList.remove('hidden');
    fieldsDiv.innerHTML='';

    let fields=[];
    if(examType==='performance'){
      if(method==='other-performance'){
        fields=[
          {id:'student-performance-areas',label:'해당 학생의 다른 수행평가 점수들',placeholder:'학생 점수',hasCalculator:true,calculatorType:'student-performance-areas'},
          {id:'class-performance-areas',label:'전체 학생의 다른 수행평가 평균들',placeholder:'평균 점수',hasCalculator:true,calculatorType:'class-performance-areas'},
          {id:'absent-performance-name',label:'결시한 수행평가 영역명',placeholder:'예: 포트폴리오',type:'text',pairWith:'absent-performance-avg'},
          {id:'absent-performance-avg',label:'결시한 수행평가 학년 평균',placeholder:'예: 82.3',pairWith:'absent-performance-name'}
        ];
      }
    }

    fields.forEach(field=>{
      const fieldDiv=document.createElement('div');
      fieldDiv.className=(field.pairWith?"grid grid-cols-2 gap-4 items-center":"mb-4");
      if(field.pairWith){
        fieldDiv.innerHTML=`
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
            <input type="${field.type||'text'}" id="${field.id}" placeholder="${field.placeholder}" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">${fields.find(f=>f.id===field.pairWith).label}</label>
            <input type="number" step="0.1" id="${field.pairWith}" placeholder="${fields.find(f=>f.id===field.pairWith).placeholder}" class="w-full px-3 py-2 border rounded-lg">
          </div>`;
      } else {
        fieldDiv.innerHTML=`
          <label class="block text-sm font-medium text-gray-700 mb-2">${field.label}</label>
          <input type="${field.type||'number'}" id="${field.id}" placeholder="${field.placeholder}" class="w-full px-3 py-2 border rounded-lg">`;
      }
      fieldsDiv.appendChild(fieldDiv);
    });
  }

  /* ✅ 수행평가명 ↔ 평균 자동 연동 */
  document.addEventListener("input", e=>{
    if(e.target.id==="absent-performance-name"){
      const name=e.target.value.trim();
      const avgInput=document.getElementById("absent-performance-avg");
      ['performance1','performance2','performance3','performance4'].forEach(key=>{
        if(savedPerformanceAreaNames[key]===name && savedAverages[key]){
          avgInput.value=savedAverages[key];
        }
      });
    }
  });
  document.addEventListener("input", e=>{
    if(e.target.id==="absent-performance-avg"){
      const avg=parseFloat(e.target.value);
      const name=document.getElementById("absent-performance-name")?.value;
      const subject=document.getElementById("student-subject").value;
      if(avg && name && subject){ savePerformanceAverage(subject,name,avg); }
    }
  });

  /* ✅ Excel 저장 기능 */
  function downloadExcel(){
    if(resultsData.length===0){ alert("저장할 데이터가 없습니다."); return; }
    const grade=document.getElementById("student-grade").value||"학년";
    const subject=document.getElementById("student-subject").value||"과목";
    const today=new Date();
    const year=today.getFullYear();
    const month=today.getMonth()+1;
    const day=today.getDate();
    let schoolYear=(month<3)?year-1:year;
    let semester=(month>=3 && month<=8)?"1학기":"2학기";
    const formattedDate= year.toString() + (month<10?"0"+month:month) + (day<10?"0"+day:day);
    const fileName=`${schoolYear}학년도 ${semester} 인정점 계산기(${grade}학년_${subject})_${formattedDate}.xlsx`;

    const worksheetData=[["번호","학년","반","번호","이름","과목","결시시험","세부명","결시사유","인정비율","산출기준","기준점","인정점","비고"]];
    resultsData.forEach(d=>worksheetData.push([d.id,d.grade,d.class,d.number,d.name,d.subject,d.examType,d.detailName,d.absenceReason,d.recognitionRate,d.calculationBasis,d.baseScore,d.finalScore,d.remarks]));
    const worksheet=XLSX.utils.aoa_to_sheet(worksheetData);
    const workbook=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook,worksheet,"결과");
    XLSX.writeFile(workbook,fileName);
  }
</script>
</body>
</html>

    </script>
</body>
</html>
