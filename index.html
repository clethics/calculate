<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일광중학교 결시자 인정점 계산기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .selected { 
            @apply ring-4 ring-blue-300 ring-opacity-50 transform scale-105; 
        }
        .btn-hover:hover { 
            @apply transform scale-105 transition-all duration-200; 
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">🏫 일광중학교 결시자 인정점 계산기 🏫</h1>
            <p class="text-gray-600 text-center mb-8">😊인정점 계산을 보다 편리하게😊</p>
            
            <!-- 학년/과목 선택 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">👤 학년/과목 선택</h2>
                <div class="bg-gray-50 rounded-xl p-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">학년</label>
                            <select id="student-grade" onchange="handleGradeSubjectChange()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">선택</option>
                                <option value="1">1학년</option>
                                <option value="2">2학년</option>
                                <option value="3">3학년</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">과목</label>
                            <select id="student-subject" onchange="handleGradeSubjectChange()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">선택</option>
                                <option value="국어">국어</option>
                                <option value="영어">영어</option>
                                <option value="수학">수학</option>
                                <option value="사회">사회</option>
                                <option value="과학">과학</option>
                                <option value="도덕">도덕</option>
                                <option value="한문">한문</option>
                                <option value="역사">역사</option>
                                <option value="기술가정">기술가정</option>
                                <option value="정보">정보</option>
                                <option value="음악">음악</option>
                                <option value="미술">미술</option>
                                <option value="체육">체육</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 평균 점수 관리 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">📊 평균 점수 관리</h2>
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                    <div class="space-y-6">
                        <!-- 지필고사 평균 -->
                        <div id="written-exam-section" class="bg-blue-50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-blue-800 mb-4">📝 지필고사 평균</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">중간고사 평균</label>
                                    <input type="number" step="0.1" id="midterm-avg-input" placeholder="예: 75.5" 
                                           oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <input type="number" step="0.1" id="midterm-min-input" placeholder="최하점 (예: 40)" 
                                           oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">기말고사 평균</label>
                                    <input type="number" step="0.1" id="final-avg-input" placeholder="예: 78.2" 
                                           oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <input type="number" step="0.1" id="final-min-input" placeholder="최하점 (예: 40)" 
                                           oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- 수행평가 평균 -->
                        <div class="bg-purple-50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-purple-800 mb-4">📋 수행평가 평균 (최대 4개 영역)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">1영역</label>
                                        <input type="text" id="perf1-name-input" placeholder="영역명 (예: 말하기)" 
                                               oninput="autoSaveAverages()" class="w-full mb-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf1-avg-input" placeholder="평균 (예: 85.3)" 
                                               oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf1-min-input" placeholder="최하점 (예: 40)" 
                                               oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">2영역</label>
                                        <input type="text" id="perf2-name-input" placeholder="영역명 (예: 듣기)" 
                                               oninput="autoSaveAverages()" class="w-full mb-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf2-avg-input" placeholder="평균 (예: 82.7)" 
                                               oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf2-min-input" placeholder="최하점 (예: 40)" 
                                               oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">3영역</label>
                                        <input type="text" id="perf3-name-input" placeholder="영역명 (예: 읽기)" 
                                               oninput="autoSaveAverages()" class="w-full mb-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf3-avg-input" placeholder="평균 (예: 79.8)" 
                                               oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf3-min-input" placeholder="최하점 (예: 40)" 
                                               oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">4영역</label>
                                        <input type="text" id="perf4-name-input" placeholder="영역명 (예: 쓰기)" 
                                               oninput="autoSaveAverages()" class="w-full mb-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf4-avg-input" placeholder="평균 (예: 81.2)" 
                                               oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf4-min-input" placeholder="최하점 (예: 40)" 
                                               oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 영어듣기 평균 (영어 과목만) -->
                        <div id="english-listening-section" class="bg-orange-50 rounded-xl p-6 hidden">
                            <h4 class="text-lg font-semibold text-orange-800 mb-4">🎧 영어듣기 평가 평균</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">영어듣기 평균</label>
                                    <input type="number" step="0.1" id="listening-avg-input" placeholder="예: 82.5" 
                                           oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                    <input type="number" step="0.1" id="listening-min-input" placeholder="최하점 (예: 40)" 
                                           oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                </div>
                            </div>
                        </div>
                    </div>
                    

                </div>
            </div>



            <!-- 계산기 모달 -->
            <div id="calculator-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">🧮 평균 계산기</h3>
                        <button type="button" onclick="closeCalculator()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">점수들을 쉼표로 구분해서 입력하세요</label>
                            <textarea id="calculator-input" placeholder="예: 85, 90, 78, 92, 88" 
                                      class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 h-24 resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">계산된 평균</label>
                            <input type="text" id="calculator-result" readonly 
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" onclick="calculateAverage()" 
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-200">
                            계산
                        </button>
                        <button type="button" onclick="applyCalculatedAverage()" 
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all duration-200">
                            적용
                        </button>
                        <button type="button" onclick="closeCalculator()" 
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-all duration-200">
                            닫기
                        </button>
                    </div>
                </div>
            </div>

            <!-- 학생 정보 입력 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">👤 학생 정보</h2>
                <div class="bg-gray-50 rounded-xl p-6">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">반</label>
                            <input type="number" id="student-class" placeholder="예: 3" min="1" max="20"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">번호</label>
                            <input type="number" id="student-number" placeholder="예: 15" min="1" max="50"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">이름</label>
                            <input type="text" id="student-name" placeholder="예: 홍길동"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 시험 유형 선택 -->
            <div id="exam-type-section" class="mb-8">
                <label class="block text-lg font-semibold text-gray-700 mb-4">결시한 시험 유형</label>
                <div id="exam-type-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button type="button" onclick="selectExamType('midterm')" id="midterm-btn" 
                            class="btn-hover bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium py-4 px-6 rounded-xl border-2 border-blue-200 transition-all duration-200">
                        중간고사
                    </button>
                    <button type="button" onclick="selectExamType('final')" id="final-btn" 
                            class="btn-hover bg-green-100 hover:bg-green-200 text-green-800 font-medium py-4 px-6 rounded-xl border-2 border-green-200 transition-all duration-200">
                        기말고사
                    </button>
                    <button type="button" onclick="selectExamType('performance')" id="performance-btn" 
                            class="btn-hover bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-4 px-6 rounded-xl border-2 border-purple-200 transition-all duration-200">
                        수행평가
                    </button>
                    <button type="button" onclick="selectExamType('english-listening')" id="english-listening-btn" 
                            class="btn-hover bg-orange-100 hover:bg-orange-200 text-orange-800 font-medium py-4 px-6 rounded-xl border-2 border-orange-200 transition-all duration-200 hidden">
                        🎧 영어듣기
                    </button>
                </div>
                <div id="performance-only-notice" class="hidden mt-4 bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <p class="text-purple-800 text-sm">
                        <strong>💡 안내:</strong> 선택하신 과목은 수행평가만 실시되는 과목입니다.
                    </p>
                </div>
                <div id="english-listening-notice" class="hidden mt-4 bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <p class="text-orange-800 text-sm">
                        <strong>🎧 안내:</strong> 영어 과목에서는 영어듣기 평가 인정점도 계산할 수 있습니다.
                    </p>
                </div>
            </div>

            <!-- 결시 사유 선택 -->
            <div id="absence-reason" class="mb-8 hidden">
                <label class="block text-lg font-semibold text-gray-700 mb-4">결시 사유</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button type="button" onclick="selectAbsenceReason('sick')" id="sick-btn" 
                            class="btn-hover bg-red-100 hover:bg-red-200 text-red-800 font-medium py-4 px-6 rounded-xl border-2 border-red-200 transition-all duration-200">
                        <div class="text-center">
                            <div class="font-semibold">병결</div>
                            <div class="text-sm">80% 인정</div>
                        </div>
                    </button>
                    <button type="button" onclick="selectAbsenceReason('approved')" id="approved-btn" 
                            class="btn-hover bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium py-4 px-6 rounded-xl border-2 border-blue-200 transition-all duration-200">
                        <div class="text-center">
                            <div class="font-semibold">인정결</div>
                            <div class="text-sm">100% 인정</div>
                        </div>
                    </button>
                    <button type="button" onclick="selectAbsenceReason('unapproved')" id="unapproved-btn" 
                            class="btn-hover bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-4 px-6 rounded-xl border-2 border-gray-200 transition-all duration-200">
                        <div class="text-center">
                            <div class="font-semibold">미인정결</div>
                            <div class="text-sm">최하점-1점</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- 계산 방식 선택 -->
            <div id="calculation-method" class="mb-8 hidden">
                <label class="block text-lg font-semibold text-gray-700 mb-4">계산 방식 선택</label>
                <div id="method-options" class="space-y-3">
                    <!-- 동적으로 생성됩니다 -->
                </div>
            </div>

            <!-- 입력 폼 -->
            <div id="input-form" class="mb-8 hidden">
                <div class="bg-gray-50 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">필요한 정보를 입력하세요</h3>
                    <div id="input-fields" class="space-y-4">
                        <!-- 동적으로 생성됩니다 -->
                    </div>
                    <button type="button" onclick="calculateScore()" 
                            class="w-full mt-6 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105">
                        인정점 계산하기
                    </button>
                </div>
            </div>

            <!-- 결과 표시 -->
            <div id="result" class="hidden">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-green-800">📊 계산 결과</h3>
                        <div class="space-x-2">
                            <button type="button" onclick="exportToExcel()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                📊 엑셀 저장
                            </button>
                            <button type="button" onclick="copyResults()" 
                                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                복사하기
                            </button>
                            <button type="button" onclick="clearResults()" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                전체 삭제
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="results-table" class="w-full border-collapse border border-gray-300 bg-white rounded-lg overflow-hidden shadow-sm">
                            <thead>
                                <tr class="bg-green-100">
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">번호</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">학년</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">반</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">번호</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">이름</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">과목</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">결시시험</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">세부명</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">결시사유</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">인정비율</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">산출기준</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">기준점</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">인정점</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">비고</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">삭제</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                                <!-- 결과가 여기에 누적됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 계산 공식 안내 버튼 -->
        <div class="text-center">
            <button type="button" onclick="openFormulaModal()" 
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-medium transition-all duration-200 border border-gray-300">
                📋 계산 공식 안내 보기
            </button>
        </div>
    </div>

    <!-- 계산 공식 안내 모달 -->
    <div id="formula-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">📋 계산 공식 안내</h3>
                <button type="button" onclick="closeFormulaModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-6">
                <h3 class="font-semibold text-yellow-800 mb-3">🎯 결시 사유별 인정 비율</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="text-center p-3 bg-red-100 rounded-lg">
                        <div class="font-semibold text-red-800">병결</div>
                        <div class="text-red-600">계산된 점수의 80%</div>
                    </div>
                    <div class="text-center p-3 bg-blue-100 rounded-lg">
                        <div class="font-semibold text-blue-800">인정결</div>
                        <div class="text-blue-600">계산된 점수의 100%</div>
                    </div>
                    <div class="text-center p-3 bg-gray-100 rounded-lg">
                        <div class="font-semibold text-gray-800">미인정결</div>
                        <div class="text-gray-600">최하점 - 1점</div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="font-semibold text-blue-800 mb-2">중간고사 인정점</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 기말고사 성적 있음: (기말점수 ÷ 기말평균) × 중간평균 × 인정비율</li>
                        <li>• 수행평가만 있음: (수행점수 ÷ 수행평균) × 중간평균 × 인정비율</li>
                        <li>• 성적 없음: 중간고사 최하점 - 1점</li>
                    </ul>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-semibold text-green-800 mb-2">기말고사 인정점</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 중간고사 성적 있음: (중간점수 ÷ 중간평균) × 기말평균 × 인정비율</li>
                        <li>• 수행평가만 있음: (수행점수 ÷ 수행평균) × 기말평균 × 인정비율</li>
                        <li>• 성적 없음: 기말고사 최하점 - 1점</li>
                    </ul>
                </div>
                <div class="border-l-4 border-purple-500 pl-4">
                    <h3 class="font-semibold text-purple-800 mb-2">수행평가 인정점</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 다른 수행평가 있음: 학생의 다른영역 평균점수 × (결시영역 학년평균 ÷ 다른영역 전체평균) × 인정비율</li>
                        <li>• 지필평가만 있음: 학생의 수행평가 평균점수 × (지필평가 전체평균 ÷ 수행평가 전체평균) × 인정비율</li>
                        <li>• 성적 없음: 수행평가 최하점 - 1점</li>
                    </ul>
                </div>
                <div class="border-l-4 border-orange-500 pl-4">
                    <h3 class="font-semibold text-orange-800 mb-2">영어듣기 평가 인정점</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 지필고사 성적 있음: (학생 영어지필점수 ÷ 영어지필평균) × 영어듣기평균 × 인정비율</li>
                        <li>• 수행평가만 있음: 학생 수행평균점수 × (영어듣기평균 ÷ 영어듣기제외 수행평균) × 인정비율</li>
                        <li>• 성적 없음: 영어듣기 최하점 - 1점</li>
                    </ul>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button type="button" onclick="closeFormulaModal()" 
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-200">
                    확인
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentExamType = '';
        let currentMethod = '';
        let currentAbsenceReason = '';
        let isPerformanceOnlySubject = false;
        let resultCounter = 0;
        let resultsData = [];
        let savedAverages = {};
        let currentCalculatorTarget = '';

        function handleSubjectChange() {
            const subject = document.getElementById('student-subject').value;
            const performanceOnlySubjects = ['음악', '미술', '체육'];
            
            isPerformanceOnlySubject = performanceOnlySubjects.includes(subject);
            
            const midtermBtn = document.getElementById('midterm-btn');
            const finalBtn = document.getElementById('final-btn');
            const englishListeningBtn = document.getElementById('english-listening-btn');
            const performanceNotice = document.getElementById('performance-only-notice');
            const englishNotice = document.getElementById('english-listening-notice');
            const examTypeButtons = document.getElementById('exam-type-buttons');
            
            // 영어듣기 관련 표시/숨김
            if (subject === '영어') {
                englishListeningBtn.classList.remove('hidden');
                englishNotice.classList.remove('hidden');
                examTypeButtons.className = 'grid grid-cols-1 md:grid-cols-4 gap-4';
            } else {
                englishListeningBtn.classList.add('hidden');
                englishNotice.classList.add('hidden');
                examTypeButtons.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
            }
            
            if (isPerformanceOnlySubject) {
                midtermBtn.disabled = true;
                finalBtn.disabled = true;
                midtermBtn.classList.add('opacity-50', 'cursor-not-allowed');
                finalBtn.classList.add('opacity-50', 'cursor-not-allowed');
                performanceNotice.classList.remove('hidden');
                selectExamType('performance');
            } else {
                midtermBtn.disabled = false;
                finalBtn.disabled = false;
                midtermBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                finalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                performanceNotice.classList.add('hidden');
                resetExamTypeSelection();
            }
        }

        function resetExamTypeSelection() {
            currentExamType = '';
            currentMethod = '';
            currentAbsenceReason = '';
            
            // 모든 버튼 초기화
            document.getElementById('midterm-btn').classList.remove('selected');
            document.getElementById('final-btn').classList.remove('selected');
            document.getElementById('performance-btn').classList.remove('selected');
            document.getElementById('english-listening-btn').classList.remove('selected');
            document.getElementById('sick-btn').classList.remove('selected');
            document.getElementById('approved-btn').classList.remove('selected');
            document.getElementById('unapproved-btn').classList.remove('selected');
            
            document.getElementById('absence-reason').classList.add('hidden');
            document.getElementById('calculation-method').classList.add('hidden');
            document.getElementById('input-form').classList.add('hidden');
        }

        function selectExamType(type) {
            if (isPerformanceOnlySubject && (type === 'midterm' || type === 'final')) {
                return;
            }
            
            currentExamType = type;
            
            // 모든 시험 유형 버튼 선택 해제
            document.getElementById('midterm-btn').classList.remove('selected');
            document.getElementById('final-btn').classList.remove('selected');
            document.getElementById('performance-btn').classList.remove('selected');
            document.getElementById('english-listening-btn').classList.remove('selected');
            
            // 선택된 버튼에 selected 클래스 추가
            if (type === 'midterm') {
                document.getElementById('midterm-btn').classList.add('selected');
            } else if (type === 'final') {
                document.getElementById('final-btn').classList.add('selected');
            } else if (type === 'performance') {
                document.getElementById('performance-btn').classList.add('selected');
            } else if (type === 'english-listening') {
                document.getElementById('english-listening-btn').classList.add('selected');
            }

            document.getElementById('absence-reason').classList.remove('hidden');
            document.getElementById('calculation-method').classList.add('hidden');
            document.getElementById('input-form').classList.add('hidden');
        }

        function selectAbsenceReason(reason) {
            currentAbsenceReason = reason;
            
            // 모든 결시 사유 버튼 선택 해제
            document.getElementById('sick-btn').classList.remove('selected');
            document.getElementById('approved-btn').classList.remove('selected');
            document.getElementById('unapproved-btn').classList.remove('selected');
            
            // 선택된 버튼에 selected 클래스 추가
            if (reason === 'sick') {
                document.getElementById('sick-btn').classList.add('selected');
            } else if (reason === 'approved') {
                document.getElementById('approved-btn').classList.add('selected');
            } else if (reason === 'unapproved') {
                document.getElementById('unapproved-btn').classList.add('selected');
            }

            showCalculationMethods(currentExamType);
        }

        function showCalculationMethods(type) {
            const methodDiv = document.getElementById('calculation-method');
            const optionsDiv = document.getElementById('method-options');
            
            if (currentAbsenceReason === 'unapproved') {
                methodDiv.classList.add('hidden');
                currentMethod = 'no-score';
                showInputForm(type, 'no-score');
                return;
            }
            
            methodDiv.classList.remove('hidden');
            optionsDiv.innerHTML = '';

            let methods = [];
            
            if (type === 'midterm') {
                methods = [
                    { id: 'final-score', label: '기말고사 성적 있음', desc: '기말고사 점수로 중간고사 인정점 계산' },
                    { id: 'performance-only', label: '수행평가 성적 있음', desc: '수행평가 점수로 중간고사 인정점 계산' },
                    { id: 'no-score', label: '성적 없음', desc: '중간고사 최하점-1점 적용' }
                ];
            } else if (type === 'final') {
                methods = [
                    { id: 'midterm-score', label: '중간고사 성적 있음', desc: '중간고사 점수로 기말고사 인정점 계산' },
                    { id: 'performance-only', label: '수행평가 성적 있음', desc: '수행평가 점수로 기말고사 인정점 계산' },
                    { id: 'no-score', label: '성적 없음', desc: '기말고사 최하점-1점 적용' }
                ];
            } else if (type === 'english-listening') {
                methods = [
                    { id: 'written-exam', label: '지필고사 성적 있음', desc: '영어 지필평가 점수로 계산' },
                    { id: 'performance-only', label: '수행평가만 있음', desc: '다른 수행평가 점수로 계산' },
                    { id: 'no-score', label: '성적 없음', desc: '영어듣기 최하점-1점 적용' }
                ];
            } else {
                if (isPerformanceOnlySubject) {
                    methods = [
                        { id: 'other-performance', label: '다른 수행평가 점수 있음', desc: '다른 영역 수행평가로 계산' },
                        { id: 'no-score', label: '성적 없음', desc: '수행평가 최하점-1점 적용' }
                    ];
                } else {
                    methods = [
                        { id: 'other-performance', label: '다른 수행평가 점수 있음', desc: '다른 영역 수행평가로 계산' },
                        { id: 'written-exam', label: '지필평가 점수 있음', desc: '중간/기말고사 점수로 계산' },
                        { id: 'no-score', label: '성적 없음', desc: '수행평가 최하점-1점 적용' }
                    ];
                }
            }

            methods.forEach((method, index) => {
                const methodBtn = document.createElement('div');
                methodBtn.className = 'method-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-300 hover:bg-blue-50 transition-all duration-200';
                methodBtn.onclick = () => selectMethod(method.id);
                methodBtn.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-800 rounded-full flex items-center justify-center font-bold text-sm mr-3">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">${method.label}</div>
                            <div class="text-sm text-gray-600">${method.desc}</div>
                        </div>
                    </div>
                `;
                optionsDiv.appendChild(methodBtn);
            });
        }

        function selectMethod(method) {
            currentMethod = method;
            
            document.querySelectorAll('.method-option').forEach(option => {
                option.classList.remove('border-blue-500', 'bg-blue-50');
                option.classList.add('border-gray-200');
            });
            
            event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
            event.currentTarget.classList.remove('border-gray-200');

            showInputForm(currentExamType, method);
        }

        function showInputForm(examType, method) {
            const formDiv = document.getElementById('input-form');
            const fieldsDiv = document.getElementById('input-fields');
            
            formDiv.classList.remove('hidden');
            fieldsDiv.innerHTML = '';

            let fields = [];

            if (examType === 'english-listening') {
                if (method === 'written-exam') {
                    fields = [
                        { id: 'student-midterm-score', label: '해당 학생의 중간고사 점수', placeholder: '예: 82 (없으면 0)', description: '해당 학생이 중간고사에서 받은 점수 (응시하지 않았으면 0 입력)' },
                        { id: 'student-final-score', label: '해당 학생의 기말고사 점수', placeholder: '예: 88 (없으면 0)', description: '해당 학생이 기말고사에서 받은 점수 (응시하지 않았으면 0 입력)' },
                        { id: 'midterm-avg', label: '전체 학생의 중간고사 평균', placeholder: '예: 75.5 (없으면 0)', description: '전체 학생들의 중간고사 평균점수 (실시하지 않았으면 0 입력)', autoFill: 'midterm-avg-input' },
                        { id: 'final-avg', label: '전체 학생의 기말고사 평균', placeholder: '예: 78.2 (없으면 0)', description: '전체 학생들의 기말고사 평균점수 (실시하지 않았으면 0 입력)', autoFill: 'final-avg-input' },
                        { id: 'listening-avg', label: '전체 학생의 영어듣기평가 평균 점수', placeholder: '예: 82.5', autoFill: 'listening-avg-input' }
                    ];
                } else if (method === 'performance-only') {
                    fields = [
                        { id: 'student-perf-score', label: '해당 학생의 영어 수행평가 평균점수', placeholder: '예: 88' },
                        { id: 'listening-avg', label: '전체 학생의 영어듣기평가 평균 점수', placeholder: '예: 82.5', autoFill: 'listening-avg-input' },
                        { id: 'perf-excluding-listening-avg', label: '영어듣기 제외한 수행평가 영역의 평균점수', placeholder: '예: 85.3', autoFill: 'getPerformanceExcludingListening' }
                    ];
                } else if (method === 'no-score') {
                    fields = [
                        { id: 'listening-min', label: '영어듣기 평가 최하점', placeholder: '예: 40', autoFill: 'listening-min-input' }
                    ];
                }
            } else if (examType === 'midterm') {
                if (method === 'final-score') {
                    fields = [
                        { id: 'midterm-avg', label: '중간고사 평균', placeholder: '예: 75.5', autoFill: 'midterm-avg-input' },
                        { id: 'final-score', label: '기말고사 점수', placeholder: '예: 85' },
                        { id: 'final-avg', label: '기말고사 평균', placeholder: '예: 78.2', autoFill: 'final-avg-input' }
                    ];
                } else if (method === 'performance-only') {
                    fields = [
                        { id: 'midterm-avg', label: '중간고사 평균', placeholder: '예: 75.5', autoFill: 'midterm-avg-input' },
                        { id: 'student-performance-areas', label: '학생이 응시한 수행평가 점수들', type: 'selective-performance', description: '학생이 실제로 응시한 수행평가 영역만 선택하여 점수를 입력하세요' },
                        { id: 'performance-avg', label: '수행평가 평균', placeholder: '예: 82.3', autoFill: 'getPerformanceAverage' }
                    ];
                } else if (method === 'no-score') {
                    fields = [
                        { id: 'midterm-min', label: '중간고사 최하점', placeholder: '예: 40', autoFill: 'midterm-min-input' }
                    ];
                }
            } else if (examType === 'final') {
                if (method === 'midterm-score') {
                    fields = [
                        { id: 'final-avg', label: '기말고사 평균', placeholder: '예: 78.2', autoFill: 'final-avg-input' },
                        { id: 'midterm-score', label: '중간고사 점수', placeholder: '예: 82' },
                        { id: 'midterm-avg', label: '중간고사 평균', placeholder: '예: 75.5', autoFill: 'midterm-avg-input' }
                    ];
                } else if (method === 'performance-only') {
                    fields = [
                        { id: 'final-avg', label: '기말고사 평균', placeholder: '예: 78.2', autoFill: 'final-avg-input' },
                        { id: 'student-performance-areas', label: '학생이 응시한 수행평가 점수들', type: 'selective-performance', description: '학생이 실제로 응시한 수행평가 영역만 선택하여 점수를 입력하세요' },
                        { id: 'performance-avg', label: '수행평가 평균', placeholder: '예: 82.3', autoFill: 'getPerformanceAverage' }
                    ];
                } else if (method === 'no-score') {
                    fields = [
                        { id: 'final-min', label: '기말고사 최하점', placeholder: '예: 40', autoFill: 'final-min-input' }
                    ];
                }
            } else if (examType === 'performance') {
                if (method === 'other-performance') {
                    fields = [
                        { id: 'absent-performance-area', label: '결시한 수행평가 영역명', placeholder: '드롭다운에서 선택', type: 'dropdown' },
                        { id: 'absent-performance-avg', label: '전체 학생 평균', placeholder: '자동 입력됨', readonly: true },
                        { id: 'performance-area1', label: '수행평가 1영역', type: 'performance-area', areaNum: 1 },
                        { id: 'performance-area2', label: '수행평가 2영역 (선택)', type: 'performance-area', areaNum: 2, optional: true },
                        { id: 'performance-area3', label: '수행평가 3영역 (선택)', type: 'performance-area', areaNum: 3, optional: true }
                    ];
                } else if (method === 'written-exam') {
                    fields = [
                        { id: 'absent-performance-area', label: '결시한 수행평가 영역명', placeholder: '드롭다운에서 선택', type: 'dropdown' },
                        { id: 'absent-performance-avg', label: '전체 학생 평균', placeholder: '자동 입력됨', readonly: true },
                        { id: 'student-performance-areas', label: '학생이 응시한 수행평가 점수들', type: 'selective-performance', description: '학생이 실제로 응시한 수행평가 영역만 선택하여 점수를 입력하세요' },
                        { id: 'midterm-score', label: '해당 학생의 중간고사 점수', placeholder: '예: 82 (없으면 0)', description: '해당 학생이 중간고사에서 받은 점수 (응시하지 않았으면 0 입력)' },
                        { id: 'midterm-avg', label: '전체 학생의 중간고사 평균', placeholder: '예: 75.5 (없으면 0)', description: '전체 학생들의 중간고사 평균점수 (실시하지 않았으면 0 입력)', autoFill: 'midterm-avg-input' },
                        { id: 'final-score', label: '해당 학생의 기말고사 점수', placeholder: '예: 85 (없으면 0)', description: '해당 학생이 기말고사에서 받은 점수 (응시하지 않았으면 0 입력)' },
                        { id: 'final-avg', label: '전체 학생의 기말고사 평균', placeholder: '예: 78.2 (없으면 0)', description: '전체 학생들의 기말고사 평균점수 (실시하지 않았으면 0 입력)', autoFill: 'final-avg-input' },
                        { id: 'performance-avg', label: '전체 학생의 수행평가 평균', placeholder: '예: 82.3', autoFill: 'getPerformanceAverage' }
                    ];
                } else if (method === 'no-score') {
                    fields = [
                        { id: 'performance-min', label: '수행평가 최하점', placeholder: '예: 40' }
                    ];
                }
            }

            fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                
                let descriptionHtml = '';
                if (field.description) {
                    descriptionHtml = `<p class="text-xs text-gray-500 mt-1">${field.description}</p>`;
                }
                
                let inputHtml = '';
                if (field.type === 'performance-area') {
                    // 수행평가 영역 필드 (영역명 선택 + 학생 점수 입력)
                    inputHtml = `
                        <div class="grid grid-cols-3 gap-2">
                            <select id="area-select-${field.areaNum}" onchange="updateAreaAverage(${field.areaNum})" 
                                    class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                                <option value="">영역 선택</option>
                            </select>
                            <input type="number" step="0.1" id="student-performance-area${field.areaNum}" placeholder="학생 점수" 
                                   class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                            <input type="number" step="0.1" id="class-performance-area${field.areaNum}" placeholder="전체 평균" 
                                   readonly class="px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                        </div>

                    `;
                } else if (field.type === 'dropdown') {
                    // 드롭다운 필드
                    inputHtml = `
                        <div class="grid grid-cols-2 gap-2">
                            <select id="${field.id}" onchange="updatePerformanceAverage()" 
                                    class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                                <option value="">영역 선택</option>
                            </select>
                            <input type="number" step="0.1" id="${field.id.replace('area', 'avg')}" placeholder="${fields.find(f => f.id === 'absent-performance-avg').placeholder}" 
                                   readonly class="px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        </div>
                    `;
                } else if (field.type === 'multiple-performance') {
                    // 다중 수행평가 점수 입력 필드
                    inputHtml = `
                        <div id="multiple-performance-container" class="space-y-3">
                            <!-- 동적으로 생성됩니다 -->
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                            <div class="text-sm text-blue-800 font-medium">계산된 학생 수행평가 평균</div>
                            <input type="number" step="0.1" id="calculated-student-performance-avg" readonly 
                                   class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        </div>
                    `;
                } else if (field.type === 'selective-performance') {
                    // 선택형 수행평가 점수 입력 필드
                    inputHtml = `
                        <div id="selective-performance-container" class="space-y-3">
                            <!-- 동적으로 생성됩니다 -->
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                            <div class="text-sm text-blue-800 font-medium">계산된 학생 수행평가 평균</div>
                            <input type="number" step="0.1" id="calculated-student-performance-avg" readonly 
                                   class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        </div>
                    `;
                } else if (field.readonly) {
                    // 읽기 전용 필드는 이미 위에서 처리됨
                    return;
                } else {
                    // 일반 입력 필드
                    let inputType = field.id.includes('score') || field.id.includes('avg') || field.id.includes('min') ? 'number' : 'text';
                    let stepAttr = inputType === 'number' ? 'step="0.1"' : '';
                    
                    inputHtml = `
                        <input type="${inputType}" ${stepAttr} id="${field.id}" placeholder="${field.placeholder}" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    `;
                }
                
                fieldDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">${field.label}</label>
                    ${inputHtml}
                    ${descriptionHtml}
                `;
                
                fieldsDiv.appendChild(fieldDiv);
                
                // 드롭다운인 경우 옵션 추가
                if (field.type === 'dropdown') {
                    populatePerformanceDropdown(field.id);
                } else if (field.type === 'performance-area') {
                    populateAreaDropdown(field.areaNum);
                } else if (field.type === 'multiple-performance') {
                    populateMultiplePerformanceFields();
                } else if (field.type === 'selective-performance') {
                    populateSelectivePerformanceFields();
                }
                
                // 자동 채우기 실행
                if (field.autoFill) {
                    setTimeout(() => {
                        autoFillField(field.id, field.autoFill);
                    }, 100);
                }
            });
        }

        function calculateScore() {
            let result = 0;
            let reasonText = '';
            
            // 결시 사유별 인정 비율
            let recognitionRate = 1.0;
            if (currentAbsenceReason === 'sick') {
                recognitionRate = 0.8;
                reasonText = '병결';
            } else if (currentAbsenceReason === 'approved') {
                recognitionRate = 1.0;
                reasonText = '인정결';
            } else if (currentAbsenceReason === 'unapproved') {
                reasonText = '미인정결';
            }
            
            try {
                // 성적 없음 처리 (모든 결시 사유에 대해)
                if (currentMethod === 'no-score') {
                    let minScore = getMinScore(currentExamType, currentMethod);
                    
                    // 저장된 최하점이 없으면 입력 필드에서 가져오기
                    if (!minScore) {
                        if (currentExamType === 'midterm') {
                            minScore = parseFloat(document.getElementById('midterm-min').value);
                        } else if (currentExamType === 'final') {
                            minScore = parseFloat(document.getElementById('final-min').value);
                        } else if (currentExamType === 'performance') {
                            minScore = parseFloat(document.getElementById('performance-min').value);
                        } else if (currentExamType === 'english-listening') {
                            minScore = parseFloat(document.getElementById('listening-min').value);
                        }
                    }
                    
                    if (isNaN(minScore) || minScore < 0) {
                        alert('최하점을 올바르게 입력해주세요.');
                        return;
                    }
                    
                    let baseScore, finalScore;
                    
                    // 성적이 없는 경우 모든 결시 사유에 대해 최하점의 차하점 적용
                    if (minScore === 0) {
                        // 최하점이 0점인 경우: 기준점 0점, 인정점 0점 (0점 하한 적용)
                        baseScore = 0;
                        finalScore = 0;
                    } else {
                        // 최하점이 0점이 아닌 경우: 기준점 최하점, 인정점 최하점-1점
                        baseScore = minScore;
                        finalScore = minScore - 1;
                    }
                    
                    addResultToTable(baseScore, finalScore, reasonText);
                    resetForm();
                    return;
                } else {
                    // 일반적인 계산
                    if (currentExamType === 'english-listening') {
                        if (currentMethod === 'written-exam') {
                            const studentMidtermScore = parseFloat(document.getElementById('student-midterm-score').value) || 0;
                            const studentFinalScore = parseFloat(document.getElementById('student-final-score').value) || 0;
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value) || 0;
                            const finalAvg = parseFloat(document.getElementById('final-avg').value) || 0;
                            const listeningAvg = parseFloat(document.getElementById('listening-avg').value);
                            
                            // 학생의 지필고사 평균 계산
                            let studentWrittenAvg = 0;
                            let classWrittenAvg = 0;
                            
                            if (studentMidtermScore > 0 && studentFinalScore > 0) {
                                studentWrittenAvg = (studentMidtermScore + studentFinalScore) / 2;
                            } else if (studentMidtermScore > 0) {
                                studentWrittenAvg = studentMidtermScore;
                            } else if (studentFinalScore > 0) {
                                studentWrittenAvg = studentFinalScore;
                            }
                            
                            if (midtermAvg > 0 && finalAvg > 0) {
                                classWrittenAvg = (midtermAvg + finalAvg) / 2;
                            } else if (midtermAvg > 0) {
                                classWrittenAvg = midtermAvg;
                            } else if (finalAvg > 0) {
                                classWrittenAvg = finalAvg;
                            }
                            
                            if (studentWrittenAvg === 0 || classWrittenAvg === 0) {
                                alert('학생의 지필고사 점수와 전체 평균을 올바르게 입력해주세요.');
                                return;
                            }
                            
                            const calculatedScore = (studentWrittenAvg / classWrittenAvg) * listeningAvg;
                            result = calculatedScore * recognitionRate;
                        } else if (currentMethod === 'performance-only') {
                            const studentPerfScore = parseFloat(document.getElementById('student-perf-score').value);
                            const listeningAvg = parseFloat(document.getElementById('listening-avg').value);
                            const perfExcludingListeningAvg = parseFloat(document.getElementById('perf-excluding-listening-avg').value);
                            
                            const calculatedScore = studentPerfScore * (listeningAvg / perfExcludingListeningAvg);
                            result = calculatedScore * recognitionRate;
                        }
                    } else if (currentExamType === 'midterm') {
                        if (currentMethod === 'final-score') {
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value);
                            const finalScore = parseFloat(document.getElementById('final-score').value);
                            const finalAvg = parseFloat(document.getElementById('final-avg').value);
                            
                            const calculatedScore = (finalScore / finalAvg) * midtermAvg;
                            result = calculatedScore * recognitionRate;
                        } else if (currentMethod === 'performance-only') {
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value);
                            const performanceScore = parseFloat(document.getElementById('calculated-student-performance-avg').value);
                            const performanceAvg = parseFloat(document.getElementById('performance-avg').value);
                            
                            const calculatedScore = (performanceScore / performanceAvg) * midtermAvg;
                            result = calculatedScore * recognitionRate;
                        }
                    } else if (currentExamType === 'final') {
                        if (currentMethod === 'midterm-score') {
                            const finalAvg = parseFloat(document.getElementById('final-avg').value);
                            const midtermScore = parseFloat(document.getElementById('midterm-score').value);
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value);
                            
                            const calculatedScore = (midtermScore / midtermAvg) * finalAvg;
                            result = calculatedScore * recognitionRate;
                        } else if (currentMethod === 'performance-only') {
                            const finalAvg = parseFloat(document.getElementById('final-avg').value);
                            const performanceScore = parseFloat(document.getElementById('calculated-student-performance-avg').value);
                            const performanceAvg = parseFloat(document.getElementById('performance-avg').value);
                            
                            const calculatedScore = (performanceScore / performanceAvg) * finalAvg;
                            result = calculatedScore * recognitionRate;
                        }
                    } else if (currentExamType === 'performance') {
                        if (currentMethod === 'other-performance') {
                            // 여러 수행평가 영역 처리
                            let studentScores = [];
                            let classAverages = [];
                            
                            // 1영역은 필수
                            const student1 = parseFloat(document.getElementById('student-performance-area1').value);
                            const class1 = parseFloat(document.getElementById('class-performance-area1').value);
                            
                            if (isNaN(student1) || isNaN(class1)) {
                                alert('1영역 점수는 필수입니다.');
                                return;
                            }
                            
                            studentScores.push(student1);
                            classAverages.push(class1);
                            
                            // 2영역 (선택)
                            const student2 = parseFloat(document.getElementById('student-performance-area2').value);
                            const class2 = parseFloat(document.getElementById('class-performance-area2').value);
                            if (!isNaN(student2) && !isNaN(class2)) {
                                studentScores.push(student2);
                                classAverages.push(class2);
                            }
                            
                            // 3영역 (선택)
                            const student3 = parseFloat(document.getElementById('student-performance-area3').value);
                            const class3 = parseFloat(document.getElementById('class-performance-area3').value);
                            if (!isNaN(student3) && !isNaN(class3)) {
                                studentScores.push(student3);
                                classAverages.push(class3);
                            }
                            
                            const absentPerformanceAvg = parseFloat(document.getElementById('absent-performance-avg').value);
                            
                            if (isNaN(absentPerformanceAvg)) {
                                alert('결시한 수행평가 영역을 선택해주세요.');
                                return;
                            }
                            
                            // 평균 계산
                            const studentOtherPerformanceAvg = studentScores.reduce((a, b) => a + b, 0) / studentScores.length;
                            const classOtherPerformanceAvg = classAverages.reduce((a, b) => a + b, 0) / classAverages.length;
                            
                            const calculatedScore = studentOtherPerformanceAvg * (absentPerformanceAvg / classOtherPerformanceAvg);
                            result = calculatedScore * recognitionRate;
                        } else if (currentMethod === 'written-exam') {
                            const studentPerformanceScore = parseFloat(document.getElementById('calculated-student-performance-avg').value);
                            const midtermScore = parseFloat(document.getElementById('midterm-score').value) || 0;
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value) || 0;
                            const finalScore = parseFloat(document.getElementById('final-score').value) || 0;
                            const finalAvg = parseFloat(document.getElementById('final-avg').value) || 0;
                            const performanceAvg = parseFloat(document.getElementById('performance-avg').value);
                            
                            if (isNaN(performanceAvg)) {
                                alert('수행평가 전체 평균을 입력해주세요.');
                                return;
                            }
                            
                            let classWrittenAvg = 0;
                            
                            if (midtermAvg > 0 && finalAvg > 0) {
                                classWrittenAvg = (midtermAvg + finalAvg) / 2;
                            } else if (midtermAvg > 0) {
                                classWrittenAvg = midtermAvg;
                            } else if (finalAvg > 0) {
                                classWrittenAvg = finalAvg;
                            }
                            
                            // 학생이 수행평가 점수가 있는 경우
                            if (!isNaN(studentPerformanceScore) && studentPerformanceScore > 0) {
                                const calculatedScore = studentPerformanceScore * (classWrittenAvg / performanceAvg);
                                result = calculatedScore * recognitionRate;
                            } else {
                                alert('학생의 수행평가 점수를 입력해주세요.');
                                return;
                            }
                        }
                    }
                }

                result = Math.round(result * 100) / 100;
                
                let baseScore, finalScore;
                
                if (currentAbsenceReason === 'sick') {
                    baseScore = result / recognitionRate;
                    finalScore = result > 100 ? 100 : result;
                } else {
                    baseScore = result;
                    finalScore = result > 100 ? 100 : result;
                }
                
                addResultToTable(baseScore, finalScore, reasonText);
                resetForm();
                
            } catch (error) {
                alert('입력값을 확인해주세요. 모든 필수 항목을 올바르게 입력해야 합니다.');
            }
        }

        function addResultToTable(baseScore, finalScore, reasonText) {
            const studentGrade = document.getElementById('student-grade').value || '-';
            const studentClass = document.getElementById('student-class').value || '-';
            const studentNumber = document.getElementById('student-number').value || '-';
            const studentName = document.getElementById('student-name').value || '-';
            const studentSubject = document.getElementById('student-subject').value || '-';
            
            const examTypeText = currentExamType === 'midterm' ? '지필고사' : 
                               currentExamType === 'final' ? '지필고사' : 
                               currentExamType === 'english-listening' ? '수행평가' : '수행평가';
            
            let detailName = '';
            if (currentExamType === 'midterm') {
                detailName = '중간고사';
            } else if (currentExamType === 'final') {
                detailName = '기말고사';
            } else if (currentExamType === 'english-listening') {
                detailName = '영어듣기';
            } else if (currentExamType === 'performance') {
                detailName = '수행평가';
            }
            
            resultCounter++;
            
            let recognitionRateText = '';
            if (currentMethod === 'no-score') {
                recognitionRateText = '최하점의 차하점';
            } else if (currentAbsenceReason === 'sick') {
                recognitionRateText = '80%';
            } else if (currentAbsenceReason === 'approved') {
                recognitionRateText = '100%';
            } else if (currentAbsenceReason === 'unapproved') {
                recognitionRateText = '최하점의 차하점';
            }
            
            let calculationBasisText = '';
            if (currentMethod === 'no-score') {
                if (currentAbsenceReason === 'unapproved') {
                    if (currentExamType === 'midterm' || currentExamType === 'final') {
                        calculationBasisText = '미응시 지필고사 최하점';
                    } else if (currentExamType === 'performance' || currentExamType === 'english-listening') {
                        calculationBasisText = '미응시 수행평가 최하점';
                    }
                } else {
                    calculationBasisText = '전 영역 미응시';
                }
            } else if (currentExamType === 'midterm') {
                if (currentMethod === 'final-score') {
                    calculationBasisText = '지필고사 점수가 있는 경우';
                } else if (currentMethod === 'performance-only') {
                    calculationBasisText = '수행평가 점수가 있는 경우';
                }
            } else if (currentExamType === 'final') {
                if (currentMethod === 'midterm-score') {
                    calculationBasisText = '지필고사 점수가 있는 경우';
                } else if (currentMethod === 'performance-only') {
                    calculationBasisText = '수행평가 점수가 있는 경우';
                }
            } else if (currentExamType === 'performance') {
                if (currentMethod === 'other-performance') {
                    calculationBasisText = '수행평가 점수가 있는 경우';
                } else if (currentMethod === 'written-exam') {
                    calculationBasisText = '지필고사 점수가 있는 경우';
                }
            } else if (currentExamType === 'english-listening') {
                if (currentMethod === 'written-exam') {
                    calculationBasisText = '지필고사 점수가 있는 경우';
                } else if (currentMethod === 'performance-only') {
                    calculationBasisText = '수행평가 점수가 있는 경우';
                }
            }
            
            let remarksText = '';
            if (baseScore > 100) {
                remarksText = '100점 상한 적용';
            }
            
            const resultData = {
                id: resultCounter,
                grade: studentGrade,
                class: studentClass,
                number: studentNumber,
                name: studentName,
                subject: studentSubject,
                examType: examTypeText,
                detailName: detailName,
                absenceReason: reasonText,
                recognitionRate: recognitionRateText,
                calculationBasis: calculationBasisText,
                baseScore: baseScore.toFixed(5),
                finalScore: Math.round(finalScore * 100) / 100,
                remarks: remarksText
            };
            resultsData.push(resultData);
            
            const tbody = document.getElementById('results-tbody');
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.id = `result-row-${resultCounter}`;
            
            const reasonClass = currentAbsenceReason === 'sick' ? 'bg-red-100 text-red-800' :
                              currentAbsenceReason === 'approved' ? 'bg-blue-100 text-blue-800' :
                              'bg-gray-100 text-gray-800';
            
            const baseScoreDisplay = baseScore > 100 ? 
                `<span class="text-orange-600 font-bold">${baseScore.toFixed(5)}점</span>` : 
                `<span class="text-blue-600">${baseScore.toFixed(5)}점</span>`;
            
            const finalScoreDisplay = baseScore > 100 ? 
                `<span class="text-green-800 font-bold">100.00점</span>` : 
                `<span class="text-green-800 font-bold">${(Math.round(finalScore * 100) / 100).toFixed(2)}점</span>`;
            
            const rateClass = currentAbsenceReason === 'sick' ? 'text-orange-600' :
                             currentAbsenceReason === 'approved' ? 'text-blue-600' :
                             'text-gray-600';
            
            row.innerHTML = `
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${resultCounter}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentGrade}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentClass}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentNumber}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentName}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentSubject}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${examTypeText}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${detailName}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <span class="px-2 py-1 rounded text-xs font-medium ${reasonClass}">
                        ${reasonText}
                    </span>
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <span class="font-medium ${rateClass}">${recognitionRateText}</span>
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm text-gray-700">${calculationBasisText}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${baseScoreDisplay}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${finalScoreDisplay}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <span class="text-xs ${remarksText ? 'text-purple-600 font-medium' : 'text-gray-400'}">${remarksText || '-'}</span>
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <button type="button" onclick="deleteResult(${resultCounter})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition-all duration-200">
                        삭제
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            const resultDiv = document.getElementById('result');
            resultDiv.classList.remove('hidden');
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteResult(id) {
            resultsData = resultsData.filter(data => data.id !== id);
            
            const row = document.getElementById(`result-row-${id}`);
            if (row) {
                row.remove();
            }
            
            if (resultsData.length === 0) {
                document.getElementById('result').classList.add('hidden');
            }
        }

        function clearResults() {
            if (resultsData.length === 0) {
                alert('삭제할 데이터가 없습니다.');
                return;
            }
            
            if (confirm('모든 결과를 삭제하시겠습니까?')) {
                resultsData = [];
                resultCounter = 0;
                document.getElementById('results-tbody').innerHTML = '';
                document.getElementById('result').classList.add('hidden');
                alert('모든 결과가 삭제되었습니다.');
            }
        }

        function exportToExcel() {
            if (resultsData.length === 0) {
                alert('저장할 데이터가 없습니다.');
                return;
            }
            
            // 파일명 생성
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            
            // 학년과 과목 정보 가져오기
            const grade = document.getElementById('student-grade').value || '전체';
            const subject = document.getElementById('student-subject').value || '전과목';
            
            const fileName = `2025학년도_2학기_인정점계산기(${grade}학년_${subject})_${dateStr}.xlsx`;
            
            // 워크시트 데이터 준비
            const headers = ['번호', '학년', '반', '학번', '이름', '과목', '결시시험', '세부명', '결시사유', '인정비율', '산출기준', '기준점', '인정점', '비고'];
            const worksheetData = [headers];
            
            resultsData.forEach(data => {
                worksheetData.push([
                    data.id,
                    data.grade,
                    data.class,
                    data.number,
                    data.name,
                    data.subject,
                    data.examType,
                    data.detailName,
                    data.absenceReason,
                    data.recognitionRate,
                    data.calculationBasis,
                    parseFloat(data.baseScore).toFixed(5),
                    typeof data.finalScore === 'number' ? data.finalScore.toFixed(2) : parseFloat(data.finalScore).toFixed(2),
                    data.remarks
                ]);
            });
            
            // XLSX 파일 생성
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // 컬럼 너비 설정
            const colWidths = [
                { wch: 6 },   // 번호
                { wch: 6 },   // 학년
                { wch: 6 },   // 반
                { wch: 6 },   // 학번
                { wch: 10 },  // 이름
                { wch: 8 },   // 과목
                { wch: 10 },  // 결시시험
                { wch: 12 },  // 세부명
                { wch: 10 },  // 결시사유
                { wch: 10 },  // 인정비율
                { wch: 18 },  // 산출기준
                { wch: 10 },  // 기준점
                { wch: 10 },  // 인정점
                { wch: 15 }   // 비고
            ];
            worksheet['!cols'] = colWidths;
            
            // 헤더 스타일 설정
            const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
            for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!worksheet[cellAddress]) continue;
                worksheet[cellAddress].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4472C4" } },
                    alignment: { horizontal: "center", vertical: "center" }
                };
            }
            
            XLSX.utils.book_append_sheet(workbook, worksheet, "인정점계산결과");
            
            // 파일 다운로드
            XLSX.writeFile(workbook, fileName);
            
            alert(`엑셀 파일이 저장되었습니다!\n파일명: ${fileName}`);
        }

        function copyResults() {
            if (resultsData.length === 0) {
                alert('복사할 데이터가 없습니다.');
                return;
            }
            
            const headers = ['번호', '학년', '반', '학번', '이름', '과목', '결시시험', '세부명', '결시사유', '인정비율', '산출기준', '기준점', '인정점', '비고'];
            let textContent = headers.join('\t') + '\n';
            
            resultsData.forEach(data => {
                const row = [
                    data.id,
                    data.grade,
                    data.class,
                    data.number,
                    data.name,
                    data.subject,
                    data.examType,
                    data.detailName,
                    data.absenceReason,
                    data.recognitionRate,
                    data.calculationBasis,
                    parseFloat(data.baseScore).toFixed(5),
                    typeof data.finalScore === 'number' ? data.finalScore.toFixed(2) : parseFloat(data.finalScore).toFixed(2),
                    data.remarks
                ].join('\t');
                textContent += row + '\n';
            });
            
            navigator.clipboard.writeText(textContent).then(() => {
                alert('데이터가 클립보드에 복사되었습니다!\nExcel에 붙여넣기(Ctrl+V)하세요.');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = textContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('데이터가 클립보드에 복사되었습니다!\nExcel에 붙여넣기(Ctrl+V)하세요.');
            });
        }

        function resetForm() {
            currentExamType = '';
            currentMethod = '';
            currentAbsenceReason = '';
            
            // 모든 버튼 초기화
            document.getElementById('midterm-btn').classList.remove('selected');
            document.getElementById('final-btn').classList.remove('selected');
            document.getElementById('performance-btn').classList.remove('selected');
            document.getElementById('english-listening-btn').classList.remove('selected');
            document.getElementById('sick-btn').classList.remove('selected');
            document.getElementById('approved-btn').classList.remove('selected');
            document.getElementById('unapproved-btn').classList.remove('selected');
            
            document.querySelectorAll('.method-option').forEach(btn => {
                btn.classList.remove('selected', 'border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            
            document.getElementById('absence-reason').classList.add('hidden');
            document.getElementById('calculation-method').classList.add('hidden');
            document.getElementById('input-form').classList.add('hidden');
            document.getElementById('input-fields').innerHTML = '';
        }

        function openFormulaModal() {
            const modal = document.getElementById('formula-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeFormulaModal() {
            const modal = document.getElementById('formula-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        


        function loadSavedAverages() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            // 모든 필드 초기화
            document.getElementById('midterm-avg-input').value = '';
            document.getElementById('midterm-min-input').value = '';
            document.getElementById('final-avg-input').value = '';
            document.getElementById('final-min-input').value = '';
            
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`perf${i}-name-input`).value = '';
                document.getElementById(`perf${i}-avg-input`).value = '';
                document.getElementById(`perf${i}-min-input`).value = '';
            }
            
            document.getElementById('listening-avg-input').value = '';
            document.getElementById('listening-min-input').value = '';
            
            if (data) {
                // 지필고사 평균 로드
                if (data.midtermAvg) document.getElementById('midterm-avg-input').value = data.midtermAvg;
                if (data.midtermMin) document.getElementById('midterm-min-input').value = data.midtermMin;
                if (data.finalAvg) document.getElementById('final-avg-input').value = data.finalAvg;
                if (data.finalMin) document.getElementById('final-min-input').value = data.finalMin;
                
                // 수행평가 평균 로드
                for (let i = 1; i <= 4; i++) {
                    if (data[`perf${i}Name`]) document.getElementById(`perf${i}-name-input`).value = data[`perf${i}Name`];
                    if (data[`perf${i}Avg`]) document.getElementById(`perf${i}-avg-input`).value = data[`perf${i}Avg`];
                    if (data[`perf${i}Min`]) document.getElementById(`perf${i}-min-input`).value = data[`perf${i}Min`];
                }
                
                // 영어듣기 평균 로드
                if (data.listeningAvg) document.getElementById('listening-avg-input').value = data.listeningAvg;
                if (data.listeningMin) document.getElementById('listening-min-input').value = data.listeningMin;
            }
        }

        function autoSaveAverages() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) {
                return;
            }
            
            const key = `${grade}-${subject}`;
            const data = {};
            
            // 지필고사 평균 저장
            const midtermAvg = document.getElementById('midterm-avg-input').value;
            const midtermMin = document.getElementById('midterm-min-input').value;
            const finalAvg = document.getElementById('final-avg-input').value;
            const finalMin = document.getElementById('final-min-input').value;
            
            if (midtermAvg) data.midtermAvg = midtermAvg;
            if (midtermMin) data.midtermMin = midtermMin;
            if (finalAvg) data.finalAvg = finalAvg;
            if (finalMin) data.finalMin = finalMin;
            
            // 수행평가 평균 저장
            for (let i = 1; i <= 4; i++) {
                const name = document.getElementById(`perf${i}-name-input`).value;
                const avg = document.getElementById(`perf${i}-avg-input`).value;
                const min = document.getElementById(`perf${i}-min-input`).value;
                
                if (name) data[`perf${i}Name`] = name;
                if (avg) data[`perf${i}Avg`] = avg;
                if (min) data[`perf${i}Min`] = min;
            }
            
            // 영어듣기 평균 저장
            const listeningAvg = document.getElementById('listening-avg-input').value;
            const listeningMin = document.getElementById('listening-min-input').value;
            
            if (listeningAvg) data.listeningAvg = listeningAvg;
            if (listeningMin) data.listeningMin = listeningMin;
            
            savedAverages[key] = data;
            localStorage.setItem('savedAverages', JSON.stringify(savedAverages));
            
            // 드롭다운 업데이트
            updateAllDropdowns();
        }
        
        function updateAllDropdowns() {
            // 수행평가 영역 드롭다운들 업데이트
            for (let i = 1; i <= 4; i++) {
                const dropdown = document.getElementById(`area-select-${i}`);
                if (dropdown) {
                    populateAreaDropdown(i);
                }
            }
            
            // 결시 수행평가 드롭다운 업데이트
            const absentDropdown = document.getElementById('absent-performance-area');
            if (absentDropdown) {
                populatePerformanceDropdown('absent-performance-area');
            }
        }

        // 계산기 함수들
        function openCalculator(targetId) {
            currentCalculatorTarget = targetId;
            document.getElementById('calculator-modal').classList.remove('hidden');
            document.getElementById('calculator-input').value = '';
            document.getElementById('calculator-result').value = '';
        }

        function closeCalculator() {
            document.getElementById('calculator-modal').classList.add('hidden');
            currentCalculatorTarget = '';
        }

        function calculateAverage() {
            const input = document.getElementById('calculator-input').value;
            if (!input.trim()) {
                alert('점수를 입력해주세요.');
                return;
            }
            
            try {
                const scores = input.split(',').map(s => parseFloat(s.trim())).filter(s => !isNaN(s));
                if (scores.length === 0) {
                    alert('올바른 점수를 입력해주세요.');
                    return;
                }
                
                const average = scores.reduce((a, b) => a + b, 0) / scores.length;
                document.getElementById('calculator-result').value = average.toFixed(2);
            } catch (error) {
                alert('점수 형식이 올바르지 않습니다. 쉼표로 구분해서 입력해주세요.');
            }
        }

        function applyCalculatedAverage() {
            const result = document.getElementById('calculator-result').value;
            if (!result) {
                alert('먼저 평균을 계산해주세요.');
                return;
            }
            
            if (currentCalculatorTarget) {
                document.getElementById(currentCalculatorTarget).value = result;
                closeCalculator();
            }
        }

        // 수행평가 드롭다운 관련 함수들
        function populatePerformanceDropdown(dropdownId) {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            const dropdown = document.getElementById(dropdownId);
            
            // 기존 옵션 제거 (첫 번째 옵션 제외)
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }
            
            if (data) {
                // 수행평가 영역들 추가
                for (let i = 1; i <= 4; i++) {
                    const name = data[`perf${i}Name`];
                    const avg = data[`perf${i}Avg`];
                    
                    if (name && avg) {
                        const option = document.createElement('option');
                        option.value = `${i}|${name}|${avg}`;
                        option.textContent = name;
                        dropdown.appendChild(option);
                    }
                }
                
                // 영어 과목인 경우 영어듣기도 추가
                if (subject === '영어' && data.listeningAvg) {
                    const option = document.createElement('option');
                    option.value = `listening|영어듣기|${data.listeningAvg}`;
                    option.textContent = '영어듣기';
                    dropdown.appendChild(option);
                }
            }
        }

        function populateAreaDropdown(areaNum) {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            const dropdown = document.getElementById(`area-select-${areaNum}`);
            
            // 기존 옵션 제거 (첫 번째 옵션 제외)
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }
            
            if (data) {
                // 수행평가 영역들 추가
                for (let i = 1; i <= 4; i++) {
                    const name = data[`perf${i}Name`];
                    const avg = data[`perf${i}Avg`];
                    
                    if (name && avg) {
                        const option = document.createElement('option');
                        option.value = `${i}|${name}|${avg}`;
                        option.textContent = name;
                        dropdown.appendChild(option);
                    }
                }
                
                // 영어 과목인 경우 영어듣기도 추가
                if (subject === '영어' && data.listeningAvg) {
                    const option = document.createElement('option');
                    option.value = `listening|영어듣기|${data.listeningAvg}`;
                    option.textContent = '영어듣기';
                    dropdown.appendChild(option);
                }
            }
        }

        function updateAreaAverage(areaNum) {
            const dropdown = document.getElementById(`area-select-${areaNum}`);
            const avgInput = document.getElementById(`class-performance-area${areaNum}`);
            
            if (dropdown.value) {
                const [index, name, avg] = dropdown.value.split('|');
                avgInput.value = avg;
            } else {
                avgInput.value = '';
            }
        }

        function updatePerformanceAverage() {
            const dropdown = document.getElementById('absent-performance-area');
            const avgInput = document.getElementById('absent-performance-avg');
            
            if (dropdown.value) {
                const [index, name, avg] = dropdown.value.split('|');
                avgInput.value = avg;
            } else {
                avgInput.value = '';
            }
        }

        // 기존 handleSubjectChange 함수 수정
        function handleGradeSubjectChange() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            const performanceOnlySubjects = ['음악', '미술', '체육'];
            
            isPerformanceOnlySubject = performanceOnlySubjects.includes(subject);
            
            const midtermBtn = document.getElementById('midterm-btn');
            const finalBtn = document.getElementById('final-btn');
            const englishListeningBtn = document.getElementById('english-listening-btn');
            const performanceNotice = document.getElementById('performance-only-notice');
            const englishNotice = document.getElementById('english-listening-notice');
            const examTypeButtons = document.getElementById('exam-type-buttons');
            
            // 영어듣기 관련 표시/숨김
            if (subject === '영어') {
                englishListeningBtn.classList.remove('hidden');
                englishNotice.classList.remove('hidden');
                examTypeButtons.className = 'grid grid-cols-1 md:grid-cols-4 gap-4';
                document.getElementById('english-listening-section').classList.remove('hidden');
            } else {
                englishListeningBtn.classList.add('hidden');
                englishNotice.classList.add('hidden');
                examTypeButtons.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
                document.getElementById('english-listening-section').classList.add('hidden');
            }
            
            // 음미체 과목인 경우 지필고사 섹션 숨김
            if (isPerformanceOnlySubject) {
                midtermBtn.disabled = true;
                finalBtn.disabled = true;
                midtermBtn.classList.add('opacity-50', 'cursor-not-allowed');
                finalBtn.classList.add('opacity-50', 'cursor-not-allowed');
                performanceNotice.classList.remove('hidden');
                document.getElementById('written-exam-section').classList.add('hidden');
                selectExamType('performance');
            } else {
                midtermBtn.disabled = false;
                finalBtn.disabled = false;
                midtermBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                finalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                performanceNotice.classList.add('hidden');
                document.getElementById('written-exam-section').classList.remove('hidden');
                resetExamTypeSelection();
            }
            
            // 저장된 평균값 자동 로드
            if (grade && subject) {
                loadSavedAverages();
            }
        }

        function loadSubjectAverages() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            // 입력 폼의 평균값들을 자동으로 채움
            if (data) {
                // 최하점 자동 적용 로직은 calculateScore에서 처리
            }
        }

        // calculateScore 함수에서 최하점 자동 적용 로직 추가
        function getMinScore(examType, method) {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return null;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            if (!data) return null;
            
            if (examType === 'midterm') {
                return data.midtermMin ? parseFloat(data.midtermMin) : null;
            } else if (examType === 'final') {
                return data.finalMin ? parseFloat(data.finalMin) : null;
            } else if (examType === 'performance') {
                // 결시한 영역의 최하점 찾기
                const dropdown = document.getElementById('absent-performance-area');
                if (dropdown && dropdown.value) {
                    const [index] = dropdown.value.split('|');
                    return data[`perf${index}Min`] ? parseFloat(data[`perf${index}Min`]) : null;
                }
            } else if (examType === 'english-listening') {
                return data.listeningMin ? parseFloat(data.listeningMin) : null;
            }
            
            return null;
        }

        // 자동 채우기 함수
        function autoFillField(fieldId, autoFillSource) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            let value = '';
            
            if (autoFillSource.startsWith('get')) {
                // 함수 호출
                if (autoFillSource === 'getWrittenAverage') {
                    value = getWrittenAverage();
                } else if (autoFillSource === 'getPerformanceAverage') {
                    value = getPerformanceAverage();
                } else if (autoFillSource === 'getPerformanceExcludingListening') {
                    value = getPerformanceExcludingListening();
                }
            } else {
                // 직접 필드에서 값 가져오기
                const sourceField = document.getElementById(autoFillSource);
                if (sourceField && sourceField.value) {
                    value = sourceField.value;
                }
            }
            
            if (value) {
                field.value = value;
            }
        }
        
        // 지필고사 평균 계산 (중간+기말 평균)
        function getWrittenAverage() {
            const midtermAvg = parseFloat(document.getElementById('midterm-avg-input').value) || 0;
            const finalAvg = parseFloat(document.getElementById('final-avg-input').value) || 0;
            
            if (midtermAvg > 0 && finalAvg > 0) {
                return ((midtermAvg + finalAvg) / 2).toFixed(1);
            } else if (midtermAvg > 0) {
                return midtermAvg.toString();
            } else if (finalAvg > 0) {
                return finalAvg.toString();
            }
            return '';
        }
        
        // 수행평가 전체 평균 계산
        function getPerformanceAverage() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return '';
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            if (!data) return '';
            
            let averages = [];
            for (let i = 1; i <= 4; i++) {
                const avg = data[`perf${i}Avg`];
                if (avg) {
                    averages.push(parseFloat(avg));
                }
            }
            
            if (averages.length > 0) {
                const totalAvg = averages.reduce((a, b) => a + b, 0) / averages.length;
                return totalAvg.toFixed(1);
            }
            
            return '';
        }
        
        // 영어듣기 제외한 수행평가 평균 계산
        function getPerformanceExcludingListening() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject || subject !== '영어') return '';
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            if (!data) return '';
            
            let averages = [];
            for (let i = 1; i <= 4; i++) {
                const name = data[`perf${i}Name`];
                const avg = data[`perf${i}Avg`];
                
                // 영역명에 '듣기'가 포함되지 않은 경우만 포함
                if (name && avg && !name.includes('듣기') && !name.includes('listening')) {
                    averages.push(parseFloat(avg));
                }
            }
            
            if (averages.length > 0) {
                const totalAvg = averages.reduce((a, b) => a + b, 0) / averages.length;
                return totalAvg.toFixed(1);
            }
            
            return '';
        }

        // 다중 수행평가 필드 생성
        function populateMultiplePerformanceFields() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            const container = document.getElementById('multiple-performance-container');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (data) {
                for (let i = 1; i <= 4; i++) {
                    const name = data[`perf${i}Name`];
                    const avg = data[`perf${i}Avg`];
                    
                    if (name && avg) {
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'grid grid-cols-3 gap-2';
                        fieldDiv.innerHTML = `
                            <div class="px-3 py-2 text-sm bg-gray-100 rounded-lg flex items-center font-medium text-gray-700">
                                ${name}
                            </div>
                            <input type="number" step="0.1" id="student-perf-${i}" placeholder="학생 점수" 
                                   oninput="calculateStudentPerformanceAverage()"
                                   class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                            <input type="number" step="0.1" value="${avg}" readonly 
                                   class="px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                        `;
                        container.appendChild(fieldDiv);
                    }
                }
            }
        }

        // 선택형 수행평가 필드 생성
        function populateSelectivePerformanceFields() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            const container = document.getElementById('selective-performance-container');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (data) {
                // 수행평가 영역들 추가
                for (let i = 1; i <= 4; i++) {
                    const name = data[`perf${i}Name`];
                    const avg = data[`perf${i}Avg`];
                    
                    if (name && avg) {
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'grid grid-cols-4 gap-2 items-center';
                        fieldDiv.innerHTML = `
                            <div class="flex items-center">
                                <input type="checkbox" id="perf-check-${i}" onchange="togglePerformanceField(${i})" 
                                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                                <label for="perf-check-${i}" class="ml-2 text-sm font-medium text-gray-700">${name}</label>
                            </div>
                            <input type="number" step="0.1" id="student-perf-${i}" placeholder="학생 점수" 
                                   oninput="calculateSelectivePerformanceAverage()" disabled
                                   class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <input type="number" step="0.1" value="${avg}" readonly 
                                   class="px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                            <div class="text-xs text-gray-500">전체평균</div>
                        `;
                        container.appendChild(fieldDiv);
                    }
                }
                
                // 영어 과목인 경우 영어듣기도 추가
                if (subject === '영어' && data.listeningAvg) {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'grid grid-cols-4 gap-2 items-center';
                    fieldDiv.innerHTML = `
                        <div class="flex items-center">
                            <input type="checkbox" id="perf-check-listening" onchange="togglePerformanceField('listening')" 
                                   class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                            <label for="perf-check-listening" class="ml-2 text-sm font-medium text-gray-700">영어듣기</label>
                        </div>
                        <input type="number" step="0.1" id="student-perf-listening" placeholder="학생 점수" 
                               oninput="calculateSelectivePerformanceAverage()" disabled
                               class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 disabled:bg-gray-100 disabled:cursor-not-allowed">
                        <input type="number" step="0.1" value="${data.listeningAvg}" readonly 
                               class="px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                        <div class="text-xs text-gray-500">전체평균</div>
                    `;
                    container.appendChild(fieldDiv);
                }
            }
        }
        
        // 학생 수행평가 평균 계산
        function calculateStudentPerformanceAverage() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            if (!data) return;
            
            let scores = [];
            for (let i = 1; i <= 4; i++) {
                const name = data[`perf${i}Name`];
                if (name) {
                    const scoreInput = document.getElementById(`student-perf-${i}`);
                    if (scoreInput && scoreInput.value) {
                        const score = parseFloat(scoreInput.value);
                        if (!isNaN(score)) {
                            scores.push(score);
                        }
                    }
                }
            }
            
            const avgInput = document.getElementById('calculated-student-performance-avg');
            if (avgInput && scores.length > 0) {
                const average = scores.reduce((a, b) => a + b, 0) / scores.length;
                avgInput.value = average.toFixed(2);
            } else if (avgInput) {
                avgInput.value = '';
            }
        }

        // 체크박스 토글 함수
        function togglePerformanceField(areaNum) {
            const checkbox = document.getElementById(`perf-check-${areaNum}`);
            const input = document.getElementById(`student-perf-${areaNum}`);
            
            if (checkbox.checked) {
                input.disabled = false;
                input.classList.remove('disabled:bg-gray-100', 'disabled:cursor-not-allowed');
                input.focus();
            } else {
                input.disabled = true;
                input.value = '';
                input.classList.add('disabled:bg-gray-100', 'disabled:cursor-not-allowed');
            }
            
            calculateSelectivePerformanceAverage();
        }

        // 선택형 수행평가 평균 계산
        function calculateSelectivePerformanceAverage() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            if (!data) return;
            
            let studentScores = [];
            let studentAreaClassAverages = []; // 학생이 응시한 영역들의 전체 학생 평균
            
            // 학생이 응시한 영역의 점수와 해당 영역의 전체 평균 수집
            for (let i = 1; i <= 4; i++) {
                const name = data[`perf${i}Name`];
                const checkbox = document.getElementById(`perf-check-${i}`);
                
                if (name && checkbox && checkbox.checked) {
                    const scoreInput = document.getElementById(`student-perf-${i}`);
                    const avg = data[`perf${i}Avg`];
                    
                    if (scoreInput && scoreInput.value && avg) {
                        const score = parseFloat(scoreInput.value);
                        const classAvg = parseFloat(avg);
                        
                        if (!isNaN(score) && !isNaN(classAvg)) {
                            studentScores.push(score);
                            studentAreaClassAverages.push(classAvg);
                        }
                    }
                }
            }
            
            // 영어 과목인 경우 영어듣기도 확인
            if (subject === '영어' && data.listeningAvg) {
                const checkbox = document.getElementById('perf-check-listening');
                
                if (checkbox && checkbox.checked) {
                    const scoreInput = document.getElementById('student-perf-listening');
                    const avg = data.listeningAvg;
                    
                    if (scoreInput && scoreInput.value && avg) {
                        const score = parseFloat(scoreInput.value);
                        const classAvg = parseFloat(avg);
                        
                        if (!isNaN(score) && !isNaN(classAvg)) {
                            studentScores.push(score);
                            studentAreaClassAverages.push(classAvg);
                        }
                    }
                }
            }
            
            const avgInput = document.getElementById('calculated-student-performance-avg');
            const classAvgInput = document.getElementById('performance-avg');
            
            if (avgInput && studentScores.length > 0) {
                // 학생 평균: 응시한 영역들만의 평균
                const studentAverage = studentScores.reduce((a, b) => a + b, 0) / studentScores.length;
                avgInput.value = studentAverage.toFixed(2);
                
                // 전체 학생 평균: 학생이 응시한 영역들의 전체 학생 평균
                if (classAvgInput && studentAreaClassAverages.length > 0) {
                    const totalClassAverage = studentAreaClassAverages.reduce((a, b) => a + b, 0) / studentAreaClassAverages.length;
                    classAvgInput.value = totalClassAverage.toFixed(2);
                }
            } else if (avgInput) {
                avgInput.value = '';
                if (classAvgInput) {
                    classAvgInput.value = '';
                }
            }
        }

        // 페이지 로드 시 저장된 평균 불러오기
        window.addEventListener('load', function() {
            const saved = localStorage.getItem('savedAverages');
            if (saved) {
                savedAverages = JSON.parse(saved);
            }
        });
    </script>
</body>
</html>
