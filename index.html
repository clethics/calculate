<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>일광중학교 결시자 인정점 계산기</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ✅ Excel 저장 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Noto Sans KR', sans-serif; }
    .selected { @apply ring-4 ring-blue-300 ring-opacity-50 transform scale-105; }
    .btn-hover:hover { @apply transform scale-105 transition-all duration-200; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
      <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">🏫 일광중학교 결시자 인정점 계산기</h1>
      <p class="text-gray-600 text-center mb-8">😊보다 편리한 인정점 계산😊</p>
      
      <!-- 학년/과목 선택 -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">👤 학년/과목 선택</h2>
        <div class="bg-gray-50 rounded-xl p-6">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">학년</label>
              <select id="student-grade" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">선택</option>
                <option value="1">1학년</option>
                <option value="2">2학년</option>
                <option value="3">3학년</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">과목</label>
              <select id="student-subject" onchange="handleSubjectChange()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">선택</option>
                <option value="국어">국어</option>
                <option value="영어">영어</option>
                <option value="수학">수학</option>
                <option value="사회">사회</option>
                <option value="과학">과학</option>
                <option value="도덕">도덕</option>
                <option value="한문">한문</option>
                <option value="역사">역사</option>
                <option value="기술가정">기술가정</option>
                <option value="정보">정보</option>
                <option value="음악">음악</option>
                <option value="미술">미술</option>
                <option value="체육">체육</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- 📊 평균 점수 관리 시작 -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">📊 평균 점수 관리</h2>
        <div class="bg-blue-50 rounded-xl p-6 mb-4">
          <div class="flex justify-between items-center mb-4">
            <p class="text-blue-800 text-sm"><strong>💡 안내:</strong> 입력한 평균 점수는 자동 저장됩니다.</p>
            <button type="button" onclick="clearAllAverages()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">전체 초기화</button>
          </div>
          
          <!-- 지필고사 평균 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="written-exam-averages">
            <div class="bg-white rounded-lg p-4 border border-blue-200">
              <h3 class="font-semibold text-blue-800 mb-2">중간고사 평균</h3>
              <div class="flex items-center space-x-2">
                <input type="number" step="0.1" id="saved-midterm-avg" onchange="saveAverage('midterm', this.value)" class="flex-1 px-3 py-2 border rounded-lg">
                <button type="button" onclick="clearAverage('midterm')" class="bg-gray-400 text-white px-2 py-1 rounded text-xs">삭제</button>
              </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-blue-200">
              <h3 class="font-semibold text-blue-800 mb-2">기말고사 평균</h3>
              <div class="flex items-center space-x-2">
                <input type="number" step="0.1" id="saved-final-avg" onchange="saveAverage('final', this.value)" class="flex-1 px-3 py-2 border rounded-lg">
                <button type="button" onclick="clearAverage('final')" class="bg-gray-400 text-white px-2 py-1 rounded text-xs">삭제</button>
              </div>
            </div>
          </div>
          
          <!-- 🎧 영어듣기 평균 -->
          <div class="grid grid-cols-1 gap-4 mb-6 hidden" id="english-listening-average">
            <div class="bg-white rounded-lg p-4 border border-orange-200">
              <h3 class="font-semibold text-orange-800 mb-2">🎧 영어듣기 평균</h3>
              <div class="flex items-center space-x-2">
                <input type="number" step="0.1" id="saved-listening-avg" onchange="saveAverage('englishListening', this.value)" class="flex-1 px-3 py-2 border rounded-lg">
                <button type="button" onclick="clearAverage('englishListening')" class="bg-gray-400 text-white px-2 py-1 rounded text-xs">삭제</button>
              </div>
            </div>
          </div>

          <!-- 🎨 수행평가 평균 (음악/미술/체육) -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden" id="performance-averages">
            <div class="bg-white rounded-lg p-4 border border-purple-200">
              <h3 class="font-semibold text-purple-800 mb-2">🎨 <span id="performance1-title">수행평가 1</span></h3>
              <input type="text" id="saved-performance1-name" placeholder="영역명" onchange="savePerformanceAreaName('performance1', this.value)" class="w-full mb-2 px-3 py-2 border rounded-lg">
              <div class="flex items-center space-x-2">
                <input type="number" step="0.1" id="saved-performance1-avg" onchange="saveAverage('performance1', this.value)" class="flex-1 px-3 py-2 border rounded-lg">
                <button type="button" onclick="clearPerformanceArea('performance1')" class="bg-gray-400 text-white px-2 py-1 rounded text-xs">삭제</button>
              </div>
            </div>
            <!-- performance2 / performance3 동일 구조 (생략X, 그대로 추가) -->
            <div class="bg-white rounded-lg p-4 border border-purple-200">
              <h3 class="font-semibold text-purple-800 mb-2">🎨 <span id="performance2-title">수행평가 2</span></h3>
              <input type="text" id="saved-performance2-name" placeholder="영역명" onchange="savePerformanceAreaName('performance2', this.value)" class="w-full mb-2 px-3 py-2 border rounded-lg">
              <div class="flex items-center space-x-2">
                <input type="number" step="0.1" id="saved-performance2-avg" onchange="saveAverage('performance2', this.value)" class="flex-1 px-3 py-2 border rounded-lg">
                <button type="button" onclick="clearPerformanceArea('performance2')" class="bg-gray-400 text-white px-2 py-1 rounded text-xs">삭제</button>
              </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-purple-200">
              <h3 class="font-semibold text-purple-800 mb-2">🎨 <span id="performance3-title">수행평가 3</span></h3>
              <input type="text" id="saved-performance3-name" placeholder="영역명" onchange="savePerformanceAreaName('performance3', this.value)" class="w-full mb-2 px-3 py-2 border rounded-lg">
              <div class="flex items-center space-x-2">
                <input type="number" step="0.1" id="saved-performance3-avg" onchange="saveAverage('performance3', this.value)" class="flex-1 px-3 py-2 border rounded-lg">
                <button type="button" onclick="clearPerformanceArea('performance3')" class="bg-gray-400 text-white px-2 py-1 rounded text-xs">삭제</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 👤 학생 정보 입력 -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">👤 학생 정보</h2>
        <div class="bg-gray-50 rounded-xl p-6">
          <div class="grid grid-cols-3 gap-4">
            <div><label class="block text-sm mb-1">반</label><input type="number" id="student-class" class="w-full px-3 py-2 border rounded-lg"></div>
            <div><label class="block text-sm mb-1">번호</label><input type="number" id="student-number" class="w-full px-3 py-2 border rounded-lg"></div>
            <div><label class="block text-sm mb-1">이름</label><input type="text" id="student-name" class="w-full px-3 py-2 border rounded-lg"></div>
          </div>
        </div>
      </div>

      <!-- 결시시험 유형 -->
      <div id="exam-type-section" class="mb-8">
        <label class="block text-lg font-semibold mb-4">결시한 시험 유형</label>
        <div id="exam-type-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button type="button" onclick="selectExamType('midterm')" id="midterm-btn" class="btn-hover bg-blue-100 px-6 py-4 rounded-xl">중간고사</button>
          <button type="button" onclick="selectExamType('final')" id="final-btn" class="btn-hover bg-green-100 px-6 py-4 rounded-xl">기말고사</button>
          <button type="button" onclick="selectExamType('performance')" id="performance-btn" class="btn-hover bg-purple-100 px-6 py-4 rounded-xl">수행평가</button>
          <button type="button" onclick="selectExamType('english-listening')" id="english-listening-btn" class="btn-hover bg-orange-100 px-6 py-4 rounded-xl hidden">영어듣기</button>
        </div>
      </div>

      <!-- 결시 사유 -->
      <div id="absence-reason" class="mb-8 hidden">
        <label class="block text-lg font-semibold mb-4">결시 사유</label>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button type="button" onclick="selectAbsenceReason('sick')" id="sick-btn" class="btn-hover bg-red-100 px-6 py-4 rounded-xl">병결</button>
          <button type="button" onclick="selectAbsenceReason('approved')" id="approved-btn" class="btn-hover bg-blue-100 px-6 py-4 rounded-xl">인정결</button>
          <button type="button" onclick="selectAbsenceReason('unapproved')" id="unapproved-btn" class="btn-hover bg-gray-100 px-6 py-4 rounded-xl">미인정결</button>
        </div>
      </div>

      <!-- 계산 방식 선택 -->
      <div id="calculation-method" class="mb-8 hidden">
        <label class="block text-lg font-semibold mb-4">계산 방식 선택</label>
        <div id="method-options" class="space-y-3"></div>
      </div>

      <!-- 입력 폼 -->
      <div id="input-form" class="mb-8 hidden">
        <div class="bg-gray-50 rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4">필요한 정보를 입력하세요</h3>
          <div id="input-fields" class="space-y-4"></div>
          <button type="button" onclick="calculateScore()" class="w-full mt-6 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl">인정점 계산하기</button>
        </div>
      </div>

      <!-- 결과 테이블 -->
      <div id="result" class="hidden">
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-green-800">📊 계산 결과</h3>
            <div class="space-x-2">
              <button onclick="copyResults()" class="bg-purple-500 text-white px-4 py-2 rounded-lg">복사하기</button>
              <button onclick="downloadXLSX()" class="bg-green-500 text-white px-4 py-2 rounded-lg">Excel 저장</button>
              <button onclick="clearResults()" class="bg-red-500 text-white px-4 py-2 rounded-lg">전체 삭제</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table id="results-table" class="w-full border-collapse border">
              <thead>
                <tr class="bg-green-100">
                  <th class="border px-3 py-2">번호</th>
                  <th class="border px-3 py-2">학년</th>
                  <th class="border px-3 py-2">반</th>
                  <th class="border px-3 py-2">번호</th>
                  <th class="border px-3 py-2">이름</th>
                  <th class="border px-3 py-2">과목</th>
                  <th class="border px-3 py-2">결시시험</th>
                  <th class="border px-3 py-2">세부명</th>
                  <th class="border px-3 py-2">결시사유</th>
                  <th class="border px-3 py-2">인정비율</th>
                  <th class="border px-3 py-2">산출기준</th>
                  <th class="border px-3 py-2">기준점</th>
                  <th class="border px-3 py-2">인정점</th>
                  <th
  <!-- 📋 계산 공식 안내 모달 -->
  <div id="formula-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-800">📋 계산 공식 안내</h3>
              <button type="button" onclick="closeFormulaModal()" class="text-gray-500 hover:text-gray-700">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
              </button>
          </div>

          <!-- 👉 중간 안내 내용: 병결/인정결/미인정결 공식, 수행평가 예시 등 기존 코드 동일 -->
          <!-- ... 그대로 있었던 안내 내용 다 두시면 됩니다 ... -->

          <div class="flex justify-end mt-6">
              <button type="button" onclick="closeFormulaModal()" 
                      class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                  확인
              </button>
          </div>
      </div>
  </div>

  <!-- 📐 계산기 모달 -->
  <div id="calculator-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
          <div class="flex justify-between items-center mb-4">
              <h3 id="calculator-title" class="text-lg font-semibold text-gray-800">평균 계산기</h3>
              <button type="button" onclick="closeCalculator()" class="text-gray-500 hover:text-gray-700">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
              </button>
          </div>
          <div id="calculator-content"><!-- 동적 생성 --></div>
          <div class="flex justify-end space-x-3 mt-6">
              <button type="button" onclick="closeCalculator()" class="px-4 py-2 bg-gray-100 rounded-lg">취소</button>
              <button type="button" onclick="applyCalculation()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">적용</button>
          </div>
      </div>
  </div>

  <!-- ✅ SCRIPT -->
  <script>
    /* 여기서부터는 당신이 올려 주신 긴 JS 코드 전체가 들어갑니다.
       (handleSubjectChange, resetExamTypeSelection, selectExamType, selectAbsenceReason,
        showCalculationMethods, selectMethod, showInputForm, calculateScore,
        addResultToTable, deleteResult, clearResults, copyResults,
        resetForm, openCalculator, closeCalculator,
        updatePerformanceAvg, updateStudentPerformanceAvg, 등등 모든 유틸리티 함수 포함) */

    // ✅ 마지막에 Excel 저장 함수 하나만 추가하면 됩니다.
    function downloadXLSX() {
        if (resultsData.length === 0) {
            alert('저장할 데이터가 없습니다.');
            return;
        }

        const headers = [
            '번호','학년','반','학번','이름','과목',
            '결시시험','세부명','결시사유','인정비율',
            '산출기준','기준점','인정점','비고'
        ];
        const rows = resultsData.map(data => [
            data.id,
            data.grade,
            data.class,
            data.number,
            data.name,
            data.subject,
            data.examType,
            data.detailName,
            data.absenceReason,
            data.recognitionRate,
            data.calculationBasis,
            Number(data.baseScore),
            Number(data.finalScore),
            data.remarks
        ]);

        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        worksheet['!cols'] = headers.map(h => ({ wch: Math.max(10, h.length + 2) }));

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "결과");

        XLSX.writeFile(workbook, "결시자_인정점.xlsx");
    }
  </script>
</body>
</html>
